<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Aktien Analyse â€“ 130 Tage Historie + Schwankungen</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial,sans-serif;margin:0;padding:15px}
h1{text-align:center;font-size:1.5rem}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem}
.infoBox{text-align:center;margin:8px;font-size:0.9rem;font-weight:bold}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
.status{text-align:center;margin:10px;font-weight:bold;font-size:0.9rem}
canvas{max-width:100%;margin:18px auto;display:block;background:#020617;border-radius:10px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.85rem}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.alert{color:#f43f5e;font-weight:bold}
.footer{text-align:center;margin-top:14px;font-size:0.7rem;color:#94a3b8}
.loader{margin-top:6px;font-size:0.85rem;color:#a8dadc}
progress{border-radius:5px}
</style>
</head>
<body>

<h1>Multi-KI Aktien Analyse â€“ 130 Tage Historie</h1>
<div class="subtitle">Live-Daten & KI-Prognosen (CHF)</div>
<div class="infoBox" id="currentPrice">Aktueller Kurs: â€“</div>
<div class="period" id="period">Zeitraum: â€“</div>

<div class="controls">
  <select id="stock"></select>
  <button onclick="run()">Analyse starten</button>
  <button onclick="openYahoo()">Yahoo</button>
  <button onclick="openTradingView()">TradingView</button>
  <button onclick="openSwissquote()">Swissquote</button>
</div>

<div class="status" id="status">Bereit</div>
<div class="loader" id="loader">â€“</div>
<div style="text-align:center;margin-bottom:10px;">
  <progress id="progressBar" value="0" max="100" style="width:80%;height:18px;"></progress>
  <div id="progressText">Warte auf Berechnungâ€¦</div>
</div>

<canvas id="chart" height="280"></canvas>

<table>
<thead>
<tr><th>KI-Modell</th><th>Prognose (CHF)</th><th>Signal</th><th>Î”</th><th>Konfidenz</th><th>Warnung</th><th>Datum/Uhrzeit</th></tr>
</thead>
<tbody id="out"></tbody>
</table>

<div class="footer">@ Lern-Tool â€“ keine Anlageberatung</div>

<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart=null;
let liveInterval=null;

// --- VorgeprÃ¼fte Aktien ---
const VALID_STOCKS=[
  {symbol:"AAPL",name:"Apple Inc."},
  {symbol:"MSFT",name:"Microsoft Corp."},
  {symbol:"NVDA",name:"NVIDIA Corp."},
  {symbol:"AMZN",name:"Amazon.com Inc."},
  {symbol:"GOOGL",name:"Alphabet Inc."},
  {symbol:"TSLA",name:"Tesla Inc."},
  {symbol:"META",name:"Meta Platforms"},
  {symbol:"JNJ",name:"Johnson & Johnson"},
  {symbol:"PFE",name:"Pfizer Inc."},
  {symbol:"MRK",name:"Merck & Co."},
  {symbol:"DIS",name:"The Walt Disney Co."},
  {symbol:"KO",name:"Coca-Cola Co."},
  {symbol:"PEP",name:"PepsiCo Inc."},
  {symbol:"ADBE",name:"Adobe Inc."},
  {symbol:"INTC",name:"Intel Corp."}
];

// Dropdown fÃ¼llen
const selectStock = document.getElementById("stock");
VALID_STOCKS.forEach(s => {
  const o = document.createElement("option");
  o.value = s.symbol;
  o.textContent = `${s.name} (${s.symbol})`;
  selectStock.appendChild(o);
});

// --- Live-Kurs ---
async function fetchUsdChf(){ 
    try{
        const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF");
        const j=await r.json();
        return Number(j?.rates?.CHF)||0.93;
    }catch{return 0.93;}
}

async function fetchQuote(sym){
    const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`);
    const j=await r.json();
    if(!j || j.c===undefined) throw "Keine Kursdaten verfÃ¼gbar";
    return Number(j.c);
}

async function startLivePrice(symbol){
    const currentDiv=document.getElementById("currentPrice");
    async function updatePrice(){
        try{
            const usd=await fetchQuote(symbol);
            const fx=await fetchUsdChf();
            currentDiv.textContent=`Aktueller Kurs: ${(usd*fx).toFixed(2)} CHF`;
        }catch(err){currentDiv.textContent=`Fehler beim Abrufen: ${err}`;}
    }
    await updatePrice();
    if(liveInterval) clearInterval(liveInterval);
    liveInterval=setInterval(updatePrice,5000);
}

selectStock.addEventListener("change",e=>{
    const sym=e.target.value;
    if(sym) startLivePrice(sym);
});

// --- Historische Daten abrufen + tÃ¤gliche Schwankungen + VolatilitÃ¤t ---
async function fetchHistoricalData(symbol, period=130){
    const now=Math.floor(Date.now()/1000);
    const start=now - period*24*60*60;
    try{
        const r = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`);
        const j = await r.json();
        if(j.s !== "ok" || !j.c || j.c.length<period) throw "Nicht genÃ¼gend historische Daten";
        const prices = j.c.map(v=>Number(v));

        // TÃ¤gliche Schwankungen
        let changes = [0];
        for(let i=1;i<prices.length;i++){
            changes.push((prices[i]-prices[i-1])/prices[i-1]);
        }

        // Gleitende VolatilitÃ¤t 10 Tage
        let volatility = Array(prices.length).fill(0);
        for(let i=9;i<prices.length;i++){
            const slice = changes.slice(i-9,i+1);
            const avg = slice.reduce((a,b)=>a+b,0)/slice.length;
            const stdDev = Math.sqrt(slice.map(d=>Math.pow(d-avg,2)).reduce((a,b)=>a+b,0)/slice.length);
            volatility[i] = stdDev;
        }

        // RÃ¼ckgabe als Array von Objekten {price, change, vol}
        return prices.map((p,i)=>({price:p, change:changes[i], vol:volatility[i]}));
    }catch{
        const usd = await fetchQuote(symbol);
        const fx = await fetchUsdChf();
        const priceChf = usd*fx;
        let arr = Array(period).fill({price:priceChf, change:0, vol:0});
        return arr;
    }
}
</script>
<script>
// --- KI-Prognose mit LSTM + Schwankungen & VolatilitÃ¤t ---
async function predictModel(data, basePeriod, label, kiIndex){
    const loaderText = document.getElementById("progressText");
    const progressBar = document.getElementById("progressBar");

    const period = basePeriod + kiIndex*2;

    // Features: Preis normalisiert, tÃ¤gliche Schwankung, VolatilitÃ¤t
    const prices = data.map(d=>d.price);
    const changes = data.map(d=>d.change);
    const vols = data.map(d=>d.vol);

    const min = Math.min(...prices);
    const max = Math.max(...prices);
    const normPrices = prices.map(v => (v - min)/(max - min || 1));

    let X=[], Y=[];
    for(let i=0; i<normPrices.length-period; i++){
        let slice=[];
        for(let j=0;j<period;j++){
            slice.push([normPrices[i+j], changes[i+j], vols[i+j]]);
        }
        X.push(slice);
        Y.push([normPrices[i+period]]);
    }

    if(X.length===0 || Y.length===0) return prices[prices.length-1];

    const xs = tf.tensor3d(X);
    const ys = tf.tensor2d(Y);

    const units = 12 + kiIndex*2;
    const model = tf.sequential();
    model.add(tf.layers.lstm({units, inputShape:[period,3]}));
    model.add(tf.layers.dense({units:1}));
    model.compile({optimizer:"adam",loss:"meanSquaredError"});

    const epochs=5;
    await model.fit(xs,ys,{epochs,verbose:0,callbacks:{
        onEpochEnd:(epoch,logs)=>{
            const totalProgress = ((kiIndex + (epoch+1)/epochs)/4)*100;
            progressBar.value = totalProgress;
            loaderText.textContent = `${label} â€“ Epoch ${epoch+1}/${epochs} (${totalProgress.toFixed(1)}%)`;
        }
    }});

    const p = model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0];
    return p*(max - min) + min;
}

// --- Ampel-Signal ---
function getSignal(diff){
    if(diff>0.05) return "KAUFEN";
    if(diff<-0.05) return "VERKAUFEN";
    return "HALTEN";
}

// --- Konfidenz ---
function getConfidence(diff){
    if(Math.abs(diff)>0.1) return "Hoch";
    if(Math.abs(diff)>0.05) return "Mittel";
    return "Niedrig";
}

// --- Warnungen massive Bewegungen ---
function getMassiveMoveAlert(data){
    if(data.length<20) return "";
    let diffs=[];
    for(let i=data.length-20;i<data.length-1;i++){
        diffs.push((data[i+1].price - data[i].price)/data[i].price);
    }
    const avgChange = diffs.reduce((a,b)=>a+b,0)/diffs.length;
    const stdDev = Math.sqrt(diffs.map(d=>Math.pow(d-avgChange,2)).reduce((a,b)=>a+b,0)/diffs.length);
    if(avgChange>0.015 && stdDev>0.02) return "ðŸš€ Massiver Anstieg mÃ¶glich!";
    if(avgChange<-0.015 && stdDev>0.02) return "âš ï¸ Massiver RÃ¼ckgang mÃ¶glich!";
    return "";
}

// --- Chart zeichnen ---
function drawChart(data, predictions){
    if(chart) chart.destroy();
    const avg = predictions.reduce((a,b)=>a+b,0)/predictions.length;
    chart = new Chart(document.getElementById("chart"),{
        type:'line',
        data:{
            labels:data.map((_,i)=>`T${i+1}`),
            datasets:[
                {label:"KI1",data:[...Array(data.length-1).fill(null), predictions[0]],borderColor:"#22c55e",fill:false},
                {label:"KI2",data:[...Array(data.length-1).fill(null), predictions[1]],borderColor:"#3b82f6",fill:false},
                {label:"KI3",data:[...Array(data.length-1).fill(null), predictions[2]],borderColor:"#f97316",fill:false},
                {label:"KI4",data:[...Array(data.length-1).fill(null), predictions[3]],borderColor:"#facc15",fill:false},
                {label:"Durchschnitt",data:[...Array(data.length-1).fill(null), avg],borderColor:"#ffffff",fill:false}
            ]
        },
        options:{responsive:true}
    });
}

// --- Analyse starten ---
async function run(){
    const sel = document.getElementById("stock").value;
    if(!sel){alert("Bitte eine Aktie auswÃ¤hlen!"); return;}
    document.getElementById("progressBar").value = 0;
    document.getElementById("progressText").textContent = "Berechnung startet...";
    document.getElementById("status").textContent = "Analyse lÃ¤uftâ€¦";

    try{
        const usd = await fetchQuote(sel);
        const fx = await fetchUsdChf();
        const priceChf = usd*fx;
        document.getElementById("currentPrice").textContent = `Aktueller Kurs: ${priceChf.toFixed(2)} CHF`;

        const basePeriod = 130;
        document.getElementById("period").textContent = `ðŸ“… KI-Prognose fÃ¼r +${basePeriod} Handelstage`;

        const hist = await fetchHistoricalData(sel, basePeriod);

        const predictions = [];
        for(let i=0;i<4;i++){
            predictions[i] = await predictModel(hist, basePeriod, `KI${i+1}`, i);
        }

        drawChart(hist, predictions);

        let html="";
        const now = new Date();
        const timeStr = now.toLocaleString();
        const alertMassive = getMassiveMoveAlert(hist);

        let combinedAlerts = [];
        predictions.forEach((p,i)=>{
            const diff = (p-priceChf)/priceChf;
            const sig = getSignal(diff);
            const conf = getConfidence(diff);
            const alert = sig==="HALTEN"? alertMassive : "";
            combinedAlerts.push(alert);
            html+=`<tr><td>KI${i+1}</td><td>${p.toFixed(2)}</td><td class="${sig.toLowerCase()}">${sig}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${conf}</td><td class="alert">${alert}</td><td>${timeStr}</td></tr>`;
        });

        const avg = predictions.reduce((a,b)=>a+b,0)/predictions.length;
        const diff = (avg-priceChf)/priceChf;
        const sig = getSignal(diff);
        const conf = getConfidence(diff);
        const avgAlert = combinedAlerts.find(a=>a)!==undefined? combinedAlerts.find(a=>a) : alertMassive;
        html+=`<tr><td>Durchschnitt</td><td>${avg.toFixed(2)}</td><td class="${sig.toLowerCase()}">${sig}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${conf}</td><td class="alert">${avgAlert}</td><td>${timeStr}</td></tr>`;

        document.getElementById("out").innerHTML = html;
        document.getElementById("status").textContent = "Fertig";

    }catch(err){document.getElementById("status").textContent = "Fehler: "+err;}
}

// --- Kauf-Links ---
function openYahoo(){window.open(`https://finance.yahoo.com/quote/${document.getElementById("stock").value}`,"_blank")}
function openTradingView(){window.open(`https://www.tradingview.com/symbols/${document.getElementById("stock").value}/`,"_blank")}
function openSwissquote(){window.open(`https://www.swissquote.ch/sqw-en/private/trading/instruments/search?query=${document.getElementById("stock").value}`,"_blank")}
</script>
</body>
</html>
