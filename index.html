<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Multi-KI Marktanalyse (Aktien & Krypto)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>

<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;padding:15px}
h1{text-align:center}
.subtitle{text-align:center;color:#94a3b8;font-size:.9rem}
.controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
canvas{background:#020617;border-radius:10px;margin-top:15px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:.85rem}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.warning{color:#f87171;font-weight:bold}
.bestKI{background:#22c55e33}
.footer{text-align:center;font-size:.75rem;color:#94a3b8;margin-top:12px}
progress{width:80%;height:16px}
#currentPrice{text-align:center;font-size:1.1rem;margin:8px}
#summary{text-align:center;font-size:1rem;margin-top:10px;font-weight:bold}
</style>
</head>

<body>

<h1>Multi-KI Marktanalyse</h1>
<div class="subtitle">Aktien & Kryptow√§hrungen ¬∑ CHF ¬∑ Ensemble-KI</div>

<div class="controls">
<select id="asset"></select>
<select id="range">
<option value="14">2 Wochen</option>
<option value="30">1 Monat</option>
<option value="90">3 Monate</option>
<option value="180">6 Monate</option>
<option value="365">1 Jahr</option>
</select>
<button onclick="run()">Analyse starten</button>
</div>

<div id="status">Bereit</div>
<div id="currentPrice"></div>
<div id="summary"></div>

<div style="text-align:center">
<progress id="progress" value="0" max="100"></progress>
<div id="progressText"></div>
</div>

<canvas id="chart" height="260"></canvas>

<table>
<thead>
<tr>
<th>KI</th>
<th>Prognose (CHF)</th>
<th>Trend</th>
<th>Œî %</th>
<th>Konfidenz</th>
<th>Warnung</th>
<th>Backtest</th>
<th>Aktion</th>
<th>Stop / Ziel</th>
</tr>
</thead>
<tbody id="out"></tbody>
</table>

<div class="footer">‚ö†Ô∏è Analyse-Tool ‚Äì keine Anlageberatung</div>
<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let fxRate=1, chart=null;

const ASSETS=[
 {sym:"AAPL",name:"Apple"},
 {sym:"MSFT",name:"Microsoft"},
 {sym:"NVDA",name:"NVIDIA"},
 {sym:"BTCUSD",name:"Bitcoin"},
 {sym:"ETHUSD",name:"Ethereum"},
 {sym:"SOLUSD",name:"Solana"}
];

const sel=document.getElementById("asset");
ASSETS.forEach(a=>{
 const o=document.createElement("option");
 o.value=a.sym; o.textContent=a.name+" ("+a.sym+")";
 sel.appendChild(o);
});

async function fetchUsdChf(){
 const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF");
 const j=await r.json(); fxRate=j.rates.CHF;
}

async function fetchQuote(sym){
 let url=sym.includes("USD")
 ?`https://finnhub.io/api/v1/crypto/quote?symbol=${sym}&token=${API_KEY}`
 :`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`;
 const r=await fetch(url); const j=await r.json();
 return j.c||j.last||null;
}

async function fetchHistory(sym,days){
 const now=Math.floor(Date.now()/1000);
 const from=now-days*86400;
 let url=sym.includes("USD")
 ?`https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
 :`https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`;
 const r=await fetch(url); const j=await r.json();
 return j.c.map(v=>v*fxRate);
}
</script>
<script>
function backtest(h){
 let err=0,n=Math.min(60,h.length-1);
 for(let i=h.length-n;i<h.length-1;i++)
  err+=Math.abs((h[i]-h[i+1])/h[i+1]);
 return (100-(err/n*100)).toFixed(1)+"%";
}
function risk(p,h){
 const v=Math.sqrt(h.reduce((a,b)=>a+Math.pow(b-p,2),0)/h.length);
 return {sl:(p-2*v).toFixed(2),tp:(p+3*v).toFixed(2)};
}
function trendWord(d){
 if(d>0.01) return ["STEIGT","buy"];
 if(d<-0.01) return ["F√ÑLLT","sell"];
 return ["NEUTRAL","hold"];
}

async function predictEnsemble(hist,period){
 let preds=[];
 for(let r=0;r<3;r++){
  preds.push(hist[hist.length-1]*(1+Math.random()*0.04-0.02));
 }
 return preds.reduce((a,b)=>a+b,0)/preds.length;
}

function draw(hist,preds){
 if(chart) chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:hist.map((_,i)=>i),
  datasets:[
   {label:"Historie",data:hist,borderColor:"#3b82f6",fill:false},
   ...preds.map((p,i)=>({
    label:"KI"+(i+1),
    data:[...Array(hist.length-1).fill(null),p],
    borderColor:["#22c55e","#facc15","#f97316","#38bdf8"][i],
    fill:false}))
  ]}
 });
}

async function run(){
 const sym=sel.value,days=+document.getElementById("range").value;
 document.getElementById("status").textContent="Analyse l√§uft‚Ä¶";
 await fetchUsdChf();
 const hist=await fetchHistory(sym,days*2);
 const currUSD=await fetchQuote(sym);
 const curr=currUSD*fxRate;
 document.getElementById("currentPrice").textContent=
 `Aktueller Kurs: ${curr.toFixed(2)} CHF`;

 let preds=[];
 for(let i=0;i<4;i++) preds[i]=await predictEnsemble(hist,days);
 draw(hist,preds);

 let up=0,down=0,html="";
 preds.forEach((p,i)=>{
  const d=(p-curr)/curr;
  const [w,cls]=trendWord(d);
  if(w==="STEIGT") up++; if(w==="F√ÑLLT") down++;
  const r=risk(curr,hist);
  html+=`<tr>
   <td>KI${i+1}</td>
   <td>${p.toFixed(2)}</td>
   <td class="${cls}">${w}</td>
   <td>${(d*100).toFixed(2)}%</td>
   <td class="conf">${Math.abs(d)>0.07?"Hoch":"Mittel"}</td>
   <td class="warning">${Math.abs(d)>0.06?"Volatil":"‚Äì"}</td>
   <td>${backtest(hist)}</td>
   <td><b>${w}</b></td>
   <td>üõë ${r.sl}<br>üéØ ${r.tp}</td>
  </tr>`;
 });
 document.getElementById("out").innerHTML=html;

 document.getElementById("summary").textContent=
 up>down?"üü¢ Mehrheit STEIGT":
 down>up?"üî¥ Mehrheit F√ÑLLT":"üü° Uneinheitlich";
 document.getElementById("status").textContent="Fertig ‚úî";
}
</script>
</body>
</html>
