<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AKTIEN KRYPTO HANDEL AG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial,sans-serif;margin:0;padding:15px}
h1{text-align:center;font-size:1.5rem;margin-bottom:2px}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:8px}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
#currentPrice{text-align:center;margin:8px;font-weight:bold;font-size:1rem}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:0.85rem}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.footer{text-align:center;margin-top:12px;font-size:0.75rem;color:#94a3b8}
canvas{max-width:100%;margin:15px auto;display:block;background:#020617;border-radius:10px}
progress{width:80%;height:16px}
.bestKI{background-color:#22c55e33;}
</style>
</head>
<body>

<h1>AKTIEN KRYPTO HANDEL AG</h1>
<div class="subtitle">Live Kurse + 4 LSTM Prognosen in CHF</div>

<div class="controls">
<select id="assetSelect"></select>
<select id="forecastRange">
<option value="5">1 Woche</option>
<option value="22">1 Monat</option>
<option value="66">3 Monate</option>
<option value="132">6 Monate</option>
<option value="264">1 Jahr</option>
</select>
<button id="runBtn">Analyse starten</button>
</div>

<div id="status">Bereit</div>
<div id="currentPrice">–</div>
<div style="text-align:center">
<progress id="progress" value="0" max="100"></progress>
<div id="progressText"></div>
</div>

<canvas id="chart" height="280"></canvas>

<table>
<thead>
<tr>
<th>KI</th><th>Prognose (CHF)</th><th>Signal</th><th>Δ %</th><th>Aktion</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="5">Bitte Asset auswählen</td></tr>
</tbody>
</table>

<div class="footer">@ AKTIEN KRYPTO HANDEL AG – Keine Anlageberatung</div>

<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart=null;
let priceInterval=null;

const assetSelect=document.getElementById("assetSelect");
const forecastRange=document.getElementById("forecastRange");
const runBtn=document.getElementById("runBtn");
const progressBar=document.getElementById("progress");
const progressText=document.getElementById("progressText");
const statusText=document.getElementById("status");
const tableBody=document.getElementById("tableBody");

// --- Aktien + Krypto ---
const ASSETS=[
{name:"Apple",symbol:"AAPL"},{name:"Microsoft",symbol:"MSFT"},
{name:"Tesla",symbol:"TSLA"},{name:"Bitcoin",symbol:"BTC-USD"},
{name:"Ethereum",symbol:"ETH-USD"},{name:"BNB",symbol:"BNB-USD"},
{name:"Cardano",symbol:"ADA-USD"},{name:"Dogecoin",symbol:"DOGE-USD"}
];

// --- Select befüllen ---
ASSETS.forEach(a=>{
  const o=document.createElement("option");
  o.value=a.symbol;
  o.textContent=`${a.name} (${a.symbol})`;
  assetSelect.appendChild(o);
});

// --- Fetch USD→CHF ---
async function fetchCHF(){ 
  try{
    const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF");
    const j=await r.json();
    return j.rates.CHF||0.93;
  }catch{return 0.93;}
}

// --- Fetch historische Preise ---
async function fetchHist(sym){
  const now=Math.floor(Date.now()/1000);
  const from=now-365*86400;
  try{
    const url=sym.includes("USD")?
      `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`:
      `https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`;
    const res=await fetch(url); const data=await res.json();
    if(data.s==="ok"&&data.c&&data.c.length>30)return data.c.map(v=>v);
  }catch{}
  return Array(365).fill(100);
}

// --- Fetch aktueller Kurs ---
async function fetchPrice(sym){
  const chf=await fetchCHF();
  try{
    const url=sym.includes("USD")?
      `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${Math.floor(Date.now()/1000)-86400}&to=${Math.floor(Date.now()/1000)}&token=${API_KEY}`:
      `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`;
    const r=await fetch(url); const j=await r.json();
    let price=sym.includes("USD")?j.c?.at(-1):j.c;
    return price?price*chf:0;
  }catch{return 0;}
}

// --- Chart ---
function drawChart(hist, forecasts){
  if(chart) chart.destroy();
  const labels=[];
  for(let i=hist.length;i>0;i--)labels.push("-"+i+"d");
  for(let i=1;i<=forecasts[0].length;i++)labels.push("+"+i+"d");

  const datasets=[{label:"Historie",data:hist,borderColor:"#3b82f6",fill:false}];
  const colors=["#22c55e","#facc15","#f97316","#38bdf8"];
  forecasts.forEach((f,i)=>datasets.push({label:"KI "+(i+1),data:[...Array(hist.length).fill(null),...f],borderColor:colors[i],fill:false,pointRadius:2}));

  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels,datasets},
    options:{responsive:true,animation:false}
  });
}

// --- Worker ---
const worker=new Worker("lstm-worker.js");
worker.onmessage=e=>{
  if(e.data.progressText) progressText.textContent=e.data.progressText;
  if(e.data.forecasts){
    drawChart(e.data.tableData.hist,e.data.forecasts);
    // Tabelle
    tableBody.innerHTML="";
    let bestValue=-Infinity,bestRow=null;
    e.data.tableData.rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.name}</td><td>${r.forecast.toFixed(2)}</td><td class="${r.cls}">${r.signal}</td><td>${r.delta}</td><td>${r.action}</td>`;
      tableBody.appendChild(tr);
      if(r.forecast>bestValue){bestValue=r.forecast; bestRow=tr;}
    });
    if(bestRow) bestRow.classList.add("bestKI");
    statusText.textContent="Fertig";
  }
};

// --- Analyse starten ---
async function runAnalysis(){
  const asset=assetSelect.value;
  if(!asset){alert("Bitte Asset auswählen");return;}
  progressBar.value=0; progressText.textContent="Lade Preise…"; statusText.textContent="Analyse läuft…";

  const hist=await fetchHist(asset);
  const chf=await fetchCHF();
  const histCHF=hist.map(p=>p*chf);
  document.getElementById("currentPrice").textContent=`Aktueller Kurs: ${(histCHF[histCHF.length-1]).toFixed(2)} CHF`;

  worker.postMessage({prices:histCHF,days:+forecastRange.value});
}

// --- Live Kurs alle 5 Sekunden ---
function startPriceInterval(){
  if(priceInterval) clearInterval(priceInterval);
  priceInterval=setInterval(async()=>{
    const asset=assetSelect.value;
    if(!asset) return;
    const price=await fetchPrice(asset);
    if(price) document.getElementById("currentPrice").textContent=`Aktueller Kurs: ${price.toFixed(2)} CHF`;
  },5000);
}

// --- Event ---
runBtn.addEventListener("click",()=>{runAnalysis(); startPriceInterval();});
</script>

</body>
</html>
