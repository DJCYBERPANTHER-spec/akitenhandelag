<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Aktien & Krypto Dashboard ‚Äì Live & Historie</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body { background:#0f172a; color:#e5e7eb; font-family:Arial,sans-serif; margin:0; padding:15px; }
h1{text-align:center;font-size:1.5rem;margin-bottom:2px;}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:8px;}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0;}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem;}
button:hover{background:#22c55e;color:#020617;cursor:pointer;}
.status{text-align:center;margin:10px;font-weight:bold;font-size:0.9rem;}
canvas{max-width:100%;margin:18px auto;display:block;background:#020617;border-radius:10px;}
.scrollable-table{max-height:320px;overflow-y:auto;margin-top:10px;}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:10px;}
th,td{border:1px solid #22c55e;padding:6px;text-align:center;}
.buy{color:#22c55e;font-weight:bold;}
.sell{color:#ef4444;font-weight:bold;}
.hold{color:#facc15;font-weight:bold;}
.warning{color:#f87171;font-weight:bold;}
.conf{color:#38bdf8;font-weight:bold;}
.footer{text-align:center;margin-top:14px;font-size:0.7rem;color:#94a3b8;}
.loader{margin-top:6px;font-size:0.85rem;color:#a8dadc;}
progress{border-radius:5px;width:80%;height:18px;}
.chart-panel{width:100%;max-width:100%;height:320px;margin-bottom:20px;}
.table-panel{width:100%;max-width:100%;margin-top:10px;}
.progress-container{width:80%;margin:0 auto;text-align:center;}
.bestKI{background-color:#22c55e33;}
#currentPrice{margin:8px 0;font-weight:bold;text-align:center;font-size:1rem;}
#buyLink{margin-top:4px;padding:6px 12px;border-radius:6px;border:1px solid #22c55e;background:#020617;color:#e5e7eb;}
#buyLink:hover{background:#22c55e;color:#020617;cursor:pointer;}
</style>
</head>
<body>

<h1>Multi-KI Aktien & Krypto Dashboard</h1>
<div class="subtitle">Live-Daten, KI-Prognosen & Historie (CHF/USD)</div>
<div class="infoBox" id="currentPrice">Aktueller Kurs: ‚Äì</div>
<div class="period" id="period">Zeitraum: ‚Äì</div>

<div class="controls">
  <select id="stock"></select>
  <select id="timeRange">
    <option value="20">1 Monat</option>
    <option value="40">2 Monate</option>
    <option value="120">6 Monate</option>
    <option value="240">1 Jahr</option>
  </select>
  <button onclick="run()">Analyse starten</button>
  <button onclick="openYahoo()">Yahoo</button>
  <button onclick="openTradingView()">TradingView</button>
  <button onclick="openSwissquote()">Swissquote</button>
</div>

<div class="status" id="status">Bereit</div>
<div class="loader" id="loader">‚Äì</div>
<div class="progress-container">
  <progress id="progressBar" value="0" max="100"></progress>
  <div id="progressText">Warte auf Berechnung‚Ä¶</div>
</div>

<div class="chart-panel">
  <canvas id="chart" height="280"></canvas>
</div>

<div class="table-panel">
  <div class="scrollable-table">
    <table>
      <thead>
        <tr>
          <th>KI</th>
          <th>Prognose (CHF/USD)</th>
          <th>Signal</th>
          <th>Œî %</th>
          <th>Konfidenz</th>
          <th>Warnung</th>
          <th>Backtest</th>
          <th>Aktion</th>
          <th>Stop / Ziel</th>
        </tr>
      </thead>
      <tbody id="out"></tbody>
    </table>
  </div>
</div>

<div style="text-align:center">
<button id="buyLink" onclick="window.open(getBuyLink(stock.value),'_blank')">Kaufen</button>
</div>

<div class="footer">@ AKTIEN HANDEL AG ‚Äì Keine Anlageberatung</div>

<script>
const API_KEY = "d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart=null, liveInterval=null, priceInterval=null;

// --- Assets (Aktien + Krypto) ---
const POSSIBLE_ASSETS = [
  {symbol:"AAPL",name:"Apple Inc."},{symbol:"MSFT",name:"Microsoft Corp."},{symbol:"NVDA",name:"NVIDIA Corp."},
  {symbol:"AMZN",name:"Amazon.com Inc."},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"TSLA",name:"Tesla Inc."},
  {symbol:"META",name:"Meta Platforms"},{symbol:"NVS",name:"Novartis AG"},{symbol:"NESN.SW",name:"Nestl√© AG"},
  {symbol:"ORCL",name:"Oracle Corp."},{symbol:"INTC",name:"Intel Corp."},{symbol:"ADBE",name:"Adobe Inc."},
  {symbol:"BTC-USD",name:"Bitcoin"},{symbol:"ETH-USD",name:"Ethereum"},{symbol:"BNB-USD",name:"Binance Coin"},
  {symbol:"SOL-USD",name:"Solana"},{symbol:"ADA-USD",name:"Cardano"},{symbol:"DOGE-USD",name:"Dogecoin"},
  {symbol:"XRP-USD",name:"Ripple"},{symbol:"LTC-USD",name:"Litecoin"},{symbol:"DOT-USD",name:"Polkadot"}
];
const selectStock = document.getElementById("stock");

// --- Validate Assets ---
async function validateAssetsSequential(){
  const loader=document.getElementById("loader");
  selectStock.innerHTML="";
  loader.textContent="Pr√ºfe Assets...";
  for(let i=0;i<POSSIBLE_ASSETS.length;i++){
    const sym=POSSIBLE_ASSETS[i].symbol;
    loader.textContent=`Pr√ºfe ${i+1}/${POSSIBLE_ASSETS.length}: ${POSSIBLE_ASSETS[i].name}`;
    try{
      const url=sym.includes("USD") ? 
        `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${Math.floor(Date.now()/1000)-30*24*60*60}&to=${Math.floor(Date.now()/1000)}&token=${API_KEY}` :
        `https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${API_KEY}`;
      const r=await fetch(url); const j=await r.json();
      if((j.s==="ok"&&j.c?.length>0)||j.name){
        const o=document.createElement("option");
        o.value=sym; o.textContent=`${POSSIBLE_ASSETS[i].name} (${sym})`;
        selectStock.appendChild(o);
      }
    }catch{}
  }
  loader.textContent="Fertig! Bitte Asset ausw√§hlen.";
}
validateAssetsSequential();

// --- Live Price ---
async function fetchUsdChf(){ try{ const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF"); const j=await r.json(); return Number(j?.rates?.CHF)||0.93;}catch{return 0.93;}}
async function fetchQuote(sym){ const url=sym.includes("USD") ? `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${Math.floor(Date.now()/1000)-60*24*60*60}&to=${Math.floor(Date.now()/1000)}&token=${API_KEY}` : `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`; const r=await fetch(url); const j=await r.json(); if(sym.includes("USD")&&j.s==="ok")return Number(j.c?.at(-1)); if(!sym.includes("USD")&&j.c!==undefined)return Number(j.c); throw "Keine Kursdaten verf√ºgbar";}
async function startLivePrice(symbol){const cur=document.getElementById("currentPrice"); async function update(){ try{ const q=await fetchQuote(symbol); const fx=await fetchUsdChf(); cur.textContent=`Aktueller Kurs: ${(q*fx).toFixed(2)} CHF`; }catch(err){cur.textContent=`Fehler: ${err}`;} } await update(); if(liveInterval)clearInterval(liveInterval); liveInterval=setInterval(update,5000);}
selectStock.addEventListener("change",e=>{if(e.target.value)startLivePrice(e.target.value);});

// --- Kauf Links ---
function openYahoo(){window.open(`https://finance.yahoo.com/quote/${selectStock.value}`,"_blank");}
function openTradingView(){window.open(`https://www.tradingview.com/symbols/${selectStock.value}/`,"_blank");}
function openSwissquote(){window.open(`https://www.swissquote.ch/sqw-en/private/trading/instruments/search?query=${selectStock.value}`,"_blank");}
function getBuyLink(sym){return `https://www.tradingview.com/symbols/${sym}/`;}

// --- LSTM KI ---
async function fetchHistoricalData(symbol,period){const now=Math.floor(Date.now()/1000); const start=now-period*24*60*60; try{const url=symbol.includes("USD")?`https://finnhub.io/api/v1/crypto/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`:`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`; const r=await fetch(url); const j=await r.json(); if(j.s!=="ok"||!j.c||j.c.length===0)throw"Keine historischen Daten"; return j.c.map(v=>Number(v)); }catch{ const q=await fetchQuote(symbol); return Array(Math.max(period,30)).fill(q);}}
async function predictLSTM(data,period){const noisy=data.map(v=>v*(1+(Math.random()-0.5)/100)); const min=Math.min(...noisy),max=Math.max(...noisy); const norm=noisy.map(v=>(v-min)/(max-min||1)); let X=[],Y=[];for(let i=0;i<norm.length-period;i++){X.push(norm.slice(i,i+period).map(v=>[v]));Y.push([norm[i+period]]);} if(X.length===0)return data[data.length-1]; const xs=tf.tensor3d(X),ys=tf.tensor2d(Y); const model=tf.sequential(); model.add(tf.layers.lstm({units:12,inputShape:[period,1]})); model.add(tf.layers.dense({units:1})); model.compile({optimizer:"adam",loss:"meanSquaredError"}); await model.fit(xs,ys,{epochs:5,verbose:0}); return model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0]*(max-min)+min;}

// --- Backtest/Risk/Warning ---
function backtest(h){let e=0,n=Math.min(60,h.length-1);for(let i=h.length-n;i<h.length-1;i++){const p=h[i]*(1+(h.slice(0,i).reduce((a,b)=>a+b,0)/20-h.slice(0,i).reduce((a,b)=>a+b,0)/100)); e+=Math.min(Math.abs((p-h[i+1])/h[i+1]),1);}return Math.max(0,((1-e/n)*100)).toFixed(1)+"%";}
function volatility(h){const avg=h.reduce((a,b)=>a+b,0)/h.length; return Math.sqrt(h.reduce((a,b)=>a+Math.pow(b-avg,2),0)/h.length)/avg;}
function calcConfidence(hist){let conf=0.5+0.3*(parseFloat(backtest(hist))/100)+0.2*(1-volatility(hist));return conf>1?1:conf;}
function risk(curr,h){const v=volatility(h)*curr;return {sl:(curr-2*v).toFixed(2),tp:(curr+3*v).toFixed(2)};}
function decision(curr,fut,h){const t=(h.slice(-20).reduce((a,b)=>a+b,0)/20-(h.slice(-100).reduce((a,b)=>a+b,0)/100))/(h.slice(-100).reduce((a,b)=>a+b,0)/100); const v=volatility(h),bt=parseFloat(backtest(h))/100; if(v>0.06||bt<0.5)return ["üü° WARTEN","Volatilit√§t oder schlechte Historie"]; if(fut>curr*1.03 && t>0)return ["üü¢ KAUFEN","Aufw√§rtstrend best√§tigt"]; if(fut<curr*0.97 && t<0)return ["üî¥ VERKAUFEN","Abw√§rtstrend best√§tigt"]; return ["‚ö™ HALTEN","Keine klare Richtung"];}
function calcWarning(dates,h){const last=h[h.length-1],prev=h[h.length-2]||last,delta=(last-prev)/prev; for(const c of [{start:"2007-10-01",end:"2009-03-01",name:"Finanzkrise 2008"},{start:"2010-04-01",end:"2012-06-30",name:"Euro-Schuldenkrise"},{start:"2020-02-01",end:"2020-04-30",name:"COVID-19 Crash"},{start:"2022-01-20",end:"2022-12-31",name:"Ukraine / Marktvolatilit√§t"}]){const start=new Date(c.start),end=new Date(c.end),d=new Date(dates?.[dates.length-1]||new Date()); if(d>=start && d<=end)return `‚ö†Ô∏è Finanzkrise: ${c.name}`;} if(delta<-0.05)return"‚ö†Ô∏è Starker Kursabfall"; if(delta>0.05)return"‚ö†Ô∏è Starker Anstieg"; return "";}

// --- Tabelle & Chart ---
async function displayTable(symbol,hist,preds){
  const out=document.getElementById("out"); let html="";
  const now=new Date(); const timeStr=now.toLocaleString();
  const price=hist[hist.length-1];
  for(let i=0;i<preds.length;i++){
    const last=preds[i],dec=decision(price,last,hist),r=risk(price,hist),conf=(calcConfidence(hist)*100).toFixed(0),warn=calcWarning(null,hist),diff=(last-price)/price*100;
    html+=`<tr>
      <td>KI${i+1}</td>
      <td>${last.toFixed(2)}</td>
      <td class="${last>price?'buy':'sell'}">${dec[0]}</td>
      <td>${diff.toFixed(2)}%</td>
      <td class="conf">${conf}%</td>
      <td class="warning">${warn}</td>
      <td>${backtest(hist)}</td>
      <td>${dec[1]}</td>
      <td>üõë ${r.sl}<br>üéØ ${r.tp}</td>
    </tr>`;
  }
  out.innerHTML=html;
}
function drawChart(hist,preds){if(chart)chart.destroy(); const avg=preds.reduce((a,b)=>a+b,0)/preds.length; chart=new Chart(document.getElementById("chart"),{type:"line",data:{labels:hist.map((_,i)=>`T${i+1}`),datasets:[...preds.map((p,i)=>({label:"KI"+(i+1),data:[...Array(hist.length-1).fill(null),p],borderColor:["#22c55e","#3b82f6","#f97316","#facc15"][i],fill:false})),{label:"Durchschnitt",data:[...Array(hist.length-1).fill(null),avg],borderColor:"#ffffff",fill:false}]}},options:{responsive:true,maintainAspectRatio:true}});}

// --- Analyse starten ---
async function run(){
  const symbol=selectStock.value; if(!symbol){alert("Bitte Asset ausw√§hlen!"); return;}
  const status=document.getElementById("status"); const progressBar=document.getElementById("progressBar"); const progressText=document.getElementById("progressText");
  status.textContent="Analyse l√§uft‚Ä¶"; progressText.textContent="Berechnung startet‚Ä¶"; progressBar.value=0;
  try{
    const basePeriod=parseInt(document.getElementById("timeRange").value);
    const hist=await fetchHistoricalData(symbol,basePeriod*2);
    const preds=[]; for(let i=0;i<4;i++){ preds[i]=await predictLSTM(hist,basePeriod+i*2); progressBar.value=((i+1)/4)*100; progressText.textContent=`KI${i+1} fertig (${progressBar.value.toFixed(1)}%)`; }
    drawChart(hist,preds); displayTable(symbol,hist,preds); status.textContent="Fertig";
  }catch(err){status.textContent="Fehler: "+err;}
}

// --- Auto Update ---
let autoInterval=null;
function startAutoUpdate(){if(autoInterval)clearInterval(autoInterval); autoInterval=setInterval(()=>{if(selectStock.value)run();},5*60*1000);}
window.addEventListener("load",()=>{selectStock.addEventListener("change",()=>{if(selectStock.value){startLivePrice(selectStock.value);run();}}); startAutoUpdate();});
</script>
</body>
</html>
