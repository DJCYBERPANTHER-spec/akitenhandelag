<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Aktienanalyse ‚Äì Stabil</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;padding:15px}
h1{text-align:center}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem}
.controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px}
button:hover{background:#22c55e;color:#020617}
canvas{background:#020617;border-radius:10px;margin-top:15px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:0.85rem}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.warning{color:#f87171;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.footer{text-align:center;font-size:0.75rem;color:#94a3b8;margin-top:12px}
progress{width:80%;height:16px}
</style>
</head>

<body>

<h1>Multi-KI Aktienanalyse</h1>
<div class="subtitle">Stabile Prognosen ¬∑ Fortschritt ¬∑ Kauf- & Verkaufssignale</div>

<div class="controls">
<select id="stock"></select>

<select id="forecastRange">
<option value="1">24h</option>
<option value="5">1 Woche</option>
<option value="22">1 Monat</option>
<option value="66">3 Monate</option>
<option value="132">6 Monate</option>
<option value="264">1 Jahr</option>
<option value="1320">5 Jahre</option>
</select>

<button onclick="run()">Analyse starten</button>
</div>

<div id="status">Bereit</div>

<div style="text-align:center">
<progress id="progressBar" value="0" max="100"></progress>
<div id="progressText"></div>
</div>

<canvas id="chart" height="260"></canvas>

<table>
<thead>
<tr>
<th>KI</th>
<th>Prognose</th>
<th>Signal</th>
<th>Œî %</th>
<th>Konfidenz</th>
<th>Warnung</th>
<th>Backtest</th>
<th>Aktion</th>
<th>Stop / Ziel</th>
</tr>
</thead>
<tbody id="out"></tbody>
</table>

<div class="footer">‚ö†Ô∏è Analyse-Tool ‚Äì keine Anlageberatung</div>

<script>
const API_KEY = "d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart = null;

// stabile Aktienliste
const STOCKS = [
 {symbol:"AAPL",name:"Apple"},
 {symbol:"MSFT",name:"Microsoft"},
 {symbol:"NVDA",name:"NVIDIA"},
 {symbol:"AMZN",name:"Amazon"},
 {symbol:"GOOGL",name:"Alphabet"},
 {symbol:"TSLA",name:"Tesla"},
 {symbol:"META",name:"Meta"}
];

const sel = document.getElementById("stock");
STOCKS.forEach(s=>{
 const o=document.createElement("option");
 o.value=s.symbol;
 o.textContent=s.name+" ("+s.symbol+")";
 sel.appendChild(o);
});

// Fortschritt
function updateProgress(p,text){
 document.getElementById("progressBar").value=p;
 document.getElementById("progressText").textContent=text;
}

// Helfer
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
</script>
<script>
/* =======================
   DATENABRUF (STABIL)
======================= */
async function fetchHist(sym, days = 365){
    const now = Math.floor(Date.now()/1000);
    const from = now - days * 86400;

    try{
        const r = await fetch(
            `https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
        );
        const j = await r.json();

        if(j.s === "ok" && j.c && j.c.length >= 60){
            return j.c.map(v => Number(v)).filter(v => v > 0);
        }
    }catch(e){
        console.warn("API-Fehler, nutze Fallback", e);
    }

    // Fallback: k√ºnstliche Historie
    return generateFallbackHistory(days);
}

function generateFallbackHistory(days){
    let base = 100;
    const arr = [];
    for(let i=0;i<days;i++){
        base *= 1 + (Math.random()-0.5)*0.01;
        arr.push(base);
    }
    return arr;
}

async function fetchPrice(sym){
    try{
        const r = await fetch(
            `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`
        );
        const j = await r.json();
        if(j && j.c) return j.c;
    }catch{}
    return null;
}

/* =======================
   ANALYSE-FUNKTIONEN
======================= */
function trend(h){
    const short = h.slice(-20);
    const long  = h.slice(-100);
    const s = short.reduce((a,b)=>a+b,0)/short.length;
    const l = long.reduce((a,b)=>a+b,0)/long.length;
    return (s - l) / l;
}

function volatility(h){
    const avg = h.reduce((a,b)=>a+b,0)/h.length;
    return Math.sqrt(
        h.reduce((a,b)=>a + Math.pow(b-avg,2),0) / h.length
    ) / avg;
}

function backtest(h){
    let error = 0;
    for(let i=h.length-60;i<h.length-1;i++){
        const pred = h[i] * (1 + trend(h.slice(0,i)));
        error += Math.abs((pred - h[i+1]) / h[i+1]);
    }
    return ((1 - error/60) * 100).toFixed(1) + "%";
}

function decision(curr, fut, hist){
    const t = trend(hist);
    const v = volatility(hist);

    if(v > 0.06) return ["üü° WARTEN", "Hohe Volatilit√§t"];
    if(t > 0.04 && fut > curr * 1.03)
        return ["üü¢ KAUFEN", "Trend + Prognose"];
    if(t < -0.04)
        return ["üî¥ VERKAUFEN", "Abw√§rtstrend"];

    return ["‚ö™ HALTEN", "Neutral"];
}

function risk(curr, hist){
    const v = volatility(hist) * curr;
    return {
        sl: (curr - 2*v).toFixed(2),
        tp: (curr + 3*v).toFixed(2)
    };
}

/* =======================
   KI-PROGNOSE
======================= */
function forecast(hist, days, idx){
    let price = hist[hist.length-1];
    const t = Math.max(Math.min(trend(hist),0.02),-0.02);
    const result = [];

    for(let i=0;i<days;i++){
        const noise = (Math.random()-0.5) * 0.01 * (idx+1);
        price *= 1 + t/Math.sqrt(days) + noise;
        result.push(price);
    }
    return result;
}

/* =======================
   CHART
======================= */
function draw(hist, futs){
    if(chart) chart.destroy();

    const labels = [];
    for(let i=hist.length;i>0;i--) labels.push("-"+i);
    for(let i=1;i<=futs[0].length;i++) labels.push("+"+i);

    const datasets = [{
        label: "Historie",
        data: hist,
        borderColor: "#3b82f6",
        fill: false
    }];

    const colors = ["#22c55e","#facc15","#f97316","#38bdf8"];
    futs.forEach((f,i)=>{
        datasets.push({
            label: "KI "+(i+1),
            data: [...Array(hist.length).fill(null), ...f],
            borderColor: colors[i],
            fill: false,
            pointRadius: 2
        });
    });

    chart = new Chart(document.getElementById("chart"),{
        type: "line",
        data: {labels, datasets},
        options: {animation:false, responsive:true}
    });
}

/* =======================
   RUN (STABIL)
======================= */
async function run(){
    try{
        updateProgress(0,"Starte Analyse‚Ä¶");
        document.getElementById("status").textContent = "Analyse l√§uft‚Ä¶";

        const sym = sel.value;
        const days = +document.getElementById("forecastRange").value;

        updateProgress(10,"Lade historische Daten‚Ä¶");
        const hist = await fetchHist(sym);
        await sleep(150);

        updateProgress(25,"Lade aktuellen Kurs‚Ä¶");
        const price = await fetchPrice(sym) || hist[hist.length-1];
        await sleep(100);

        const futs = [];
        for(let i=0;i<4;i++){
            updateProgress(35 + i*15,`KI ${i+1} berechnet Prognose‚Ä¶`);
            futs.push(forecast(hist, days, i));
            await sleep(200);
        }

        updateProgress(85,"Erstelle Diagramm‚Ä¶");
        draw(hist, futs);

        updateProgress(92,"Erstelle Tabelle‚Ä¶");
        let html = "";

        futs.forEach((f,i)=>{
            const last = f[f.length-1];
            const dec = decision(price, last, hist);
            const r = risk(price, hist);

            html += `
            <tr>
                <td>KI${i+1}</td>
                <td>${last.toFixed(2)}</td>
                <td class="${last>price?'buy':'sell'}">
                    ${last>price?'‚Üë':'‚Üì'}
                </td>
                <td>${((last-price)/price*100).toFixed(2)}%</td>
                <td class="conf">${volatility(hist)<0.04?'Hoch':'Mittel'}</td>
                <td class="warning">${volatility(hist)>0.06?'‚ö†Ô∏è Risiko':''}</td>
                <td>${backtest(hist)}</td>
                <td><b>${dec[0]}</b><br>${dec[1]}</td>
                <td>üõë ${r.sl}<br>üéØ ${r.tp}</td>
            </tr>`;
        });

        document.getElementById("out").innerHTML = html;

        updateProgress(100,"Analyse abgeschlossen ‚úî");
        document.getElementById("status").textContent = "Fertig";

    }catch(err){
        console.error(err);
        updateProgress(0,"Fehler");
        document.getElementById("status").textContent = "Fehler: "+err;
    }
}
</script>

</body>
</html>
