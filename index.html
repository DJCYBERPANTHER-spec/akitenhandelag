<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Aktien & Krypto Dashboard – CHF</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial,sans-serif;margin:0;padding:15px}
h1{text-align:center;font-size:1.5rem;margin-bottom:2px}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:8px}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
.status{text-align:center;margin:10px;font-weight:bold;font-size:0.9rem}
canvas{max-width:100%;margin:18px auto;display:block;background:#020617;border-radius:10px}
.scrollable-table{max-height:320px;overflow-y:auto;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:10px}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.warning{color:#f87171;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.footer{text-align:center;margin-top:14px;font-size:0.7rem;color:#94a3b8}
progress{border-radius:5px;width:80%;height:18px}
.chart-panel{width:100%;max-width:100%;height:320px;margin-bottom:20px}
.table-panel{width:100%;max-width:100%;margin-top:10px}
.progress-container{width:80%;margin:0 auto;text-align:center}
.bestKI{background-color:#22c55e33}
#currentPrice{margin:8px 0;font-weight:bold;text-align:center;font-size:1rem}
#buyLink{margin-top:4px;padding:6px 12px;border-radius:6px;border:1px solid #22c55e;background:#020617;color:#e5e7eb}
#buyLink:hover{background:#22c55e;color:#020617;cursor:pointer}
</style>
</head>
<body>

<h1>Multi-KI Aktien & Krypto Dashboard</h1>
<div class="subtitle">Live-Daten, KI-Prognosen & Historie (CHF)</div>
<div class="infoBox" id="currentPrice">Aktueller Kurs: –</div>
<div class="period" id="period">Zeitraum: –</div>

<div class="controls">
  <select id="stock"></select>
  <select id="timeRange">
    <option value="20">1 Monat</option>
    <option value="40">2 Monate</option>
    <option value="120">6 Monate</option>
    <option value="240">1 Jahr</option>
  </select>
  <button id="runBtn">Analyse starten</button>
  <button onclick="openYahoo()">Yahoo</button>
  <button onclick="openTradingView()">TradingView</button>
  <button onclick="openSwissquote()">Swissquote</button>
</div>

<div class="status" id="status">Bereit</div>
<div class="loader" id="loader">–</div>
<div class="progress-container">
  <progress id="progressBar" value="0" max="100"></progress>
  <div id="progressText">Warte auf Berechnung…</div>
</div>

<div class="chart-panel">
  <canvas id="chart" height="280"></canvas>
</div>

<div class="table-panel">
  <div class="scrollable-table">
    <table>
      <thead>
        <tr>
          <th>KI</th>
          <th>Prognose (CHF)</th>
          <th>Signal</th>
          <th>Δ %</th>
          <th>Konfidenz</th>
          <th>Warnung</th>
          <th>Backtest</th>
          <th>Aktion</th>
          <th>Stop / Ziel</th>
        </tr>
      </thead>
      <tbody id="out"></tbody>
    </table>
  </div>
</div>

<div style="text-align:center">
  <button id="buyLink">Kaufen</button>
</div>

<div class="footer">@ AKTIEN HANDEL AG – Keine Anlageberatung</div>

<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart=null, liveInterval=null;

const POSSIBLE_ASSETS=[
  {symbol:"AAPL",name:"Apple Inc."},{symbol:"MSFT",name:"Microsoft Corp."},{symbol:"NVDA",name:"NVIDIA Corp."},
  {symbol:"AMZN",name:"Amazon.com Inc."},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"TSLA",name:"Tesla Inc."},
  {symbol:"META",name:"Meta Platforms"},{symbol:"BTC-USD",name:"Bitcoin"},{symbol:"ETH-USD",name:"Ethereum"},
  {symbol:"BNB-USD",name:"Binance Coin"},{symbol:"SOL-USD",name:"Solana"},{symbol:"ADA-USD",name:"Cardano"},
  {symbol:"DOGE-USD",name:"Dogecoin"},{symbol:"XRP-USD",name:"Ripple"},{symbol:"LTC-USD",name:"Litecoin"}
];

const selectStock=document.getElementById("stock");
const loader=document.getElementById("loader");
const runBtn=document.getElementById("runBtn");

// --- Prüfen + Liste füllen beim Start ---
async function validateAssetsSequential(){
  selectStock.innerHTML="";
  loader.textContent="Prüfe Assets...";
  for(let i=0;i<POSSIBLE_ASSETS.length;i++){
    const sym=POSSIBLE_ASSETS[i].symbol;
    loader.textContent=`Prüfe ${i+1}/${POSSIBLE_ASSETS.length}: ${POSSIBLE_ASSETS[i].name}`;
    try{
      let available=false;
      if(sym.includes("USD")){
        const now=Math.floor(Date.now()/1000);
        const res=await fetch(`https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${now-3*24*60*60}&to=${now}&token=${API_KEY}`);
        const data=await res.json();
        if(data.s==="ok" && data.c?.length>0) available=true;
      }else{
        const res=await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${API_KEY}`);
        const data=await res.json();
        if(data.name) available=true;
      }
      if(available){
        const o=document.createElement("option");
        o.value=sym;
        o.textContent=`${POSSIBLE_ASSETS[i].name} (${sym})`;
        selectStock.appendChild(o);
      }
    }catch{}
  }
  loader.textContent="Fertig! Bitte Asset auswählen.";

  // --- Nach der Prüfung den EventListener aktivieren ---
  selectStock.addEventListener("change",()=>startLivePrice(selectStock.value));
  runBtn.addEventListener("click",()=>run());
}
validateAssetsSequential();

// --- USD→CHF ---
async function fetchUsdChf(){try{ const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF"); const j=await r.json(); return Number(j?.rates?.CHF)||0.93;}catch{return 0.93;}}
<script>
// --- Aktueller Kurs & Live-Update ---
async function fetchQuote(sym){
    try{
        if(sym.includes("USD")){
            const now=Math.floor(Date.now()/1000);
            const res=await fetch(`https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${now-1*24*60*60}&to=${now}&token=${API_KEY}`);
            const data=await res.json();
            if(data.s==="ok") return Number(data.c.at(-1));
        }else{
            const res=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`);
            const data=await res.json();
            if(data && data.c) return Number(data.c);
        }
    }catch{}
    return null;
}

let fxRate=0;
async function updateUsdChf(){ fxRate=await fetchUsdChf(); }
updateUsdChf();

// --- Live-Kurs anzeigen ---
async function startLivePrice(sym){
    const currentDiv=document.getElementById("currentPrice");
    async function update(){
        const price=await fetchQuote(sym);
        if(price!==null) currentDiv.textContent=`Aktueller Kurs: ${(price*fxRate).toFixed(2)} CHF`;
    }
    await update();
    if(liveInterval) clearInterval(liveInterval);
    liveInterval=setInterval(update,5000);
}

// --- Historische Daten ---
async function fetchHistoricalData(sym,days){
    const now=Math.floor(Date.now()/1000);
    const start=now-days*24*60*60;
    try{
        let url=sym.includes("USD") 
            ? `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`
            : `https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`;
        const res=await fetch(url);
        const data=await res.json();
        if(data.s==="ok" && data.c?.length>0) return data.c.map(Number);
    }catch{}
    const fallback=Array(days).fill(100); // Notfall
    return fallback;
}

// --- KI-Prognose (einfaches LSTM) ---
async function predictLSTM(data,period){
    const noisy=data.map(v=>v*(1+(Math.random()-0.5)/100));
    const min=Math.min(...noisy), max=Math.max(...noisy);
    const norm=noisy.map(v=>(v-min)/(max-min||1));
    let X=[], Y=[];
    for(let i=0;i<norm.length-period;i++){ X.push(norm.slice(i,i+period).map(v=>[v])); Y.push([norm[i+period]]);}
    if(X.length===0) return data[data.length-1];
    const xs=tf.tensor3d(X), ys=tf.tensor2d(Y);
    const model=tf.sequential();
    model.add(tf.layers.lstm({units:12,inputShape:[period,1]}));
    model.add(tf.layers.dense({units:1}));
    model.compile({optimizer:"adam",loss:"meanSquaredError"});
    await model.fit(xs,ys,{epochs:5,verbose:0});
    const p=model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0];
    return p*(max-min)+min;
}

// --- Konfidenz ---
function getConfidence(diff){ return Math.abs(diff)>0.1?"Hoch":Math.abs(diff)>0.05?"Mittel":"Niedrig";}

// --- Tabelle & Chart ---
function drawChart(hist,preds){
    if(chart) chart.destroy();
    const avg=preds.reduce((a,b)=>a+b,0)/preds.length;
    chart=new Chart(document.getElementById("chart"),{
        type:'line',
        data:{
            labels:hist.map((_,i)=>`T${i+1}`),
            datasets:[
                {label:"KI1",data:[...Array(hist.length-1).fill(null), preds[0]*fxRate], borderColor:"#22c55e",fill:false},
                {label:"KI2",data:[...Array(hist.length-1).fill(null), preds[1]*fxRate], borderColor:"#3b82f6",fill:false},
                {label:"KI3",data:[...Array(hist.length-1).fill(null), preds[2]*fxRate], borderColor:"#f97316",fill:false},
                {label:"KI4",data:[...Array(hist.length-1).fill(null), preds[3]*fxRate], borderColor:"#facc15",fill:false},
                {label:"Durchschnitt",data:[...Array(hist.length-1).fill(null), avg*fxRate],borderColor:"#ffffff",fill:false},
            ]
        },
        options:{responsive:true, maintainAspectRatio:true}
    });
}

function displayTable(symbol,hist,preds){
    const out=document.getElementById("out");
    let html="";
    const now=new Date();
    const timeStr=now.toLocaleString();
    preds.forEach((p,i)=>{
        const diff=(p-hist[hist.length-1])/hist[hist.length-1];
        const sig=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
        html+=`<tr>
            <td>KI${i+1}</td>
            <td>${(p*fxRate).toFixed(2)}</td>
            <td class="${sig.toLowerCase()}">${sig}</td>
            <td>${(diff*100).toFixed(1)}%</td>
            <td class="conf">${getConfidence(diff)}</td>
            <td>–</td>
            <td>–</td>
            <td>–</td>
            <td>–</td>
        </tr>`;
    });
    const avg=preds.reduce((a,b)=>a+b,0)/preds.length;
    const diff=(avg-hist[hist.length-1])/hist[hist.length-1];
    const sig=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
    html+=`<tr class="bestKI">
        <td>Durchschnitt</td>
        <td>${(avg*fxRate).toFixed(2)}</td>
        <td class="${sig.toLowerCase()}">${sig}</td>
        <td>${(diff*100).toFixed(1)}%</td>
        <td class="conf">${getConfidence(diff)}</td>
        <td>–</td><td>–</td><td>–</td><td>–</td>
    </tr>`;
    out.innerHTML=html;
}

// --- Kaufen-Link ---
document.getElementById("buyLink").addEventListener("click",()=>{
    const sym=selectStock.value;
    if(sym) window.open(`https://finance.yahoo.com/quote/${sym}`,"_blank");
});

// --- Buttons extern ---
function openYahoo(){window.open(`https://finance.yahoo.com/quote/${selectStock.value}`,"_blank");}
function openTradingView(){window.open(`https://www.tradingview.com/symbols/${selectStock.value}/`,"_blank");}
function openSwissquote(){window.open(`https://www.swissquote.ch/sqw-en/private/trading/instruments/search?query=${selectStock.value}`,"_blank");}

// --- Analyse starten ---
async function run(){
    const symbol=selectStock.value;
    if(!symbol){alert("Bitte ein Asset auswählen!"); return;}
    const period=parseInt(document.getElementById("timeRange").value);
    document.getElementById("status").textContent="Analyse läuft…";
    document.getElementById("progressText").textContent="Daten abrufen…";
    document.getElementById("progressBar").value=0;

    const hist=await fetchHistoricalData(symbol,period*2);
    document.getElementById("progressBar").value=25;

    const preds=[];
    for(let i=0;i<4;i++){
        preds[i]=await predictLSTM(hist,period+i*2);
        document.getElementById("progressBar").value=25+15*i;
        document.getElementById("progressText").textContent=`KI ${i+1} fertig`;
    }

    drawChart(hist,preds);
    displayTable(symbol,hist,preds);
    document.getElementById("status").textContent="Fertig";
    document.getElementById("progressBar").value=100;
    document.getElementById("progressText").textContent="Analyse abgeschlossen ✔";

    startLivePrice(symbol);
}

</script>
</body>
</html>
