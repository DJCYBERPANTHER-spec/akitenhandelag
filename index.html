<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AKTIEN HANDEL AG â€“ Aktien, Krypto Live</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:Arial,sans-serif;
  margin:0;
  padding:15px;
}
h1{text-align:center;font-size:1.5rem;margin-bottom:2px;}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:8px;}
.infoBox{text-align:center;margin:8px;font-size:0.9rem;font-weight:bold;}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0;}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem;}
button:hover{background:#22c55e;color:#020617;cursor:pointer;}
.status{text-align:center;margin:10px;font-weight:bold;font-size:0.9rem;}
canvas{max-width:100%;margin:18px auto;display:block;background:#020617;border-radius:10px;}
.scrollable-table{max-height:280px;overflow-y:auto;margin-top:10px;}
table{width:100%;border-collapse:collapse;font-size:0.85rem;}
th,td{border:1px solid #22c55e;padding:6px;text-align:center;}
.buy{color:#22c55e;font-weight:bold;}
.sell{color:#ef4444;font-weight:bold;}
.hold{color:#facc15;font-weight:bold;}
.conf{color:#38bdf8;font-weight:bold;}
.footer{text-align:center;margin-top:14px;font-size:0.7rem;color:#94a3b8;}
.loader{margin-top:6px;font-size:0.85rem;color:#a8dadc;}
progress{border-radius:5px;}
.chart-panel{width:100%;max-width:100%;height:320px;margin-bottom:20px;}
.table-panel{width:100%;max-width:100%;margin-top:10px;}
.progress-container{width:80%;margin:0 auto;text-align:center;}
</style>
</head>
<body>

<h1>Multi-KI Aktien & Krypto Dashboard â€“ Live</h1>
<div class="subtitle">Echte Live-Daten & KI-Prognosen (CHF/USD)</div>
<div class="infoBox" id="currentPrice">Aktueller Kurs: â€“</div>
<div class="period" id="period">Zeitraum: â€“</div>

<div class="controls">
  <select id="stock"></select>
  <select id="timeRange">
    <option value="20">1 Monat</option>
    <option value="40">2 Monate</option>
    <option value="120">6 Monate</option>
    <option value="240">1 Jahr</option>
  </select>
  <button onclick="run()">Analyse starten</button>
  <button onclick="openYahoo()">Yahoo</button>
  <button onclick="openTradingView()">TradingView</button>
  <button onclick="openSwissquote()">Swissquote</button>
</div>

<div class="status" id="status">Bereit</div>
<div class="loader" id="loader">â€“</div>
<div class="progress-container">
  <progress id="progressBar" value="0" max="100" style="width:100%;height:18px;"></progress>
  <div id="progressText">Warte auf Berechnungâ€¦</div>
</div>

<div class="chart-panel">
  <canvas id="chart" height="280"></canvas>
</div>

<div class="table-panel">
  <div class="scrollable-table">
    <table>
      <thead>
        <tr><th>Asset</th><th>Prognose (CHF/USD)</th><th>Signal</th><th>Î”</th><th>Konfidenz</th><th>Datum/Uhrzeit</th></tr>
      </thead>
      <tbody id="out"></tbody>
    </table>
  </div>
</div>

<div class="footer">@ AKTIEN HANDEL AG â€“ Keine Anlageberatung</div>
<script>
const API_KEY = "d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";

let chart = null;
let liveInterval = null;

// --- Multi-Asset Listen (Aktien + Krypto) ---
const POSSIBLE_ASSETS = [
  // Aktien
  {symbol:"AAPL",name:"Apple Inc."},{symbol:"MSFT",name:"Microsoft Corp."},{symbol:"NVDA",name:"NVIDIA Corp."},
  {symbol:"AMZN",name:"Amazon.com Inc."},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"TSLA",name:"Tesla Inc."},
  {symbol:"META",name:"Meta Platforms"},{symbol:"NVS",name:"Novartis AG"},{symbol:"NESN.SW",name:"NestlÃ© AG"},
  {symbol:"ORCL",name:"Oracle Corp."},{symbol:"INTC",name:"Intel Corp."},{symbol:"ADBE",name:"Adobe Inc."},
  // Krypto
  {symbol:"BTC-USD",name:"Bitcoin"},{symbol:"ETH-USD",name:"Ethereum"},{symbol:"BNB-USD",name:"Binance Coin"},
  {symbol:"SOL-USD",name:"Solana"},{symbol:"ADA-USD",name:"Cardano"},{symbol:"DOGE-USD",name:"Dogecoin"},
  {symbol:"XRP-USD",name:"Ripple"},{symbol:"LTC-USD",name:"Litecoin"},{symbol:"DOT-USD",name:"Polkadot"}
];

// --- Select-Element ---
const selectStock = document.getElementById("stock");

// --- Assets nacheinander prÃ¼fen, nur verfÃ¼gbare hinzufÃ¼gen ---
async function validateAssetsSequential() {
    const loader = document.getElementById("loader");
    selectStock.innerHTML = "";
    loader.textContent = "PrÃ¼fe Assets nacheinander...";

    for (let i = 0; i < POSSIBLE_ASSETS.length; i++) {
        const sym = POSSIBLE_ASSETS[i].symbol;
        loader.textContent = `PrÃ¼fe ${i+1}/${POSSIBLE_ASSETS.length}: ${POSSIBLE_ASSETS[i].name}`;
        try {
            let url = sym.includes("USD") 
                ? `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${Math.floor(Date.now()/1000)-30*24*60*60}&to=${Math.floor(Date.now()/1000)}&token=${API_KEY}`
                : `https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${API_KEY}`;
            const r = await fetch(url);
            const j = await r.json();
            if ((j.s === "ok" && j.c?.length>0) || j.name) {
                const o = document.createElement("option");
                o.value = sym;
                o.textContent = `${POSSIBLE_ASSETS[i].name} (${sym})`;
                selectStock.appendChild(o);
            }
        } catch{}
    }
    loader.textContent = "Fertig! Bitte Asset auswÃ¤hlen.";
}
validateAssetsSequential();

// --- Live-Kurse fÃ¼r Aktien + Krypto alle 5 Sekunden ---
async function fetchUsdChf(){ 
    try{
        const r = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF");
        const j = await r.json();
        return Number(j?.rates?.CHF)||0.93;
    }catch{return 0.93;}
}

async function fetchQuote(sym){
    let url = sym.includes("USD")
        ? `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${Math.floor(Date.now()/1000)-60*24*60*60}&to=${Math.floor(Date.now()/1000)}&token=${API_KEY}`
        : `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`;
    const r = await fetch(url);
    const j = await r.json();
    if (sym.includes("USD") && j.s==="ok") return Number(j.c?.at(-1));
    if (!sym.includes("USD") && j.c!==undefined) return Number(j.c);
    throw "Keine Kursdaten verfÃ¼gbar";
}

async function startLivePrice(symbol){
    const currentDiv = document.getElementById("currentPrice");
    async function updatePrice(){
        try{
            const quote = await fetchQuote(symbol);
            const fx = await fetchUsdChf();
            currentDiv.textContent = `Aktueller Kurs: ${(quote*fx).toFixed(2)} CHF`;
        }catch(err){currentDiv.textContent=`Fehler beim Abrufen: ${err}`;}
    }
    await updatePrice();
    if(liveInterval) clearInterval(liveInterval);
    liveInterval = setInterval(updatePrice,5000);
}

selectStock.addEventListener("change", e => {
    const sym = e.target.value;
    if(sym) startLivePrice(sym);
});

// --- Kauf-Links ---
function openYahoo(){ window.open(`https://finance.yahoo.com/quote/${selectStock.value}`, "_blank"); }
function openTradingView(){ window.open(`https://www.tradingview.com/symbols/${selectStock.value}/`, "_blank"); }
function openSwissquote(){ window.open(`https://www.swissquote.ch/sqw-en/private/trading/instruments/search?query=${selectStock.value}`, "_blank"); }
</script>
<script>
// ================= Historische Daten abrufen =================
async function fetchHistoricalData(symbol, period){
    const now = Math.floor(Date.now()/1000);
    const start = now - period*24*60*60;
    try{
        let url = symbol.includes("USD")
            ? `https://finnhub.io/api/v1/crypto/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`
            : `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`;
        const r = await fetch(url);
        const j = await r.json();
        if(j.s !== "ok" || !j.c || j.c.length===0) throw "Keine historischen Daten verfÃ¼gbar";
        return j.c.map(v=>Number(v));
    }catch{
        const quote = await fetchQuote(symbol);
        return Array(Math.max(period,30)).fill(quote);
    }
}

// ================= KI-Prognose =================
async function predictLSTM(data, period){
    const noisy = data.map(v => v*(1+(Math.random()-0.5)/100));
    const min = Math.min(...noisy), max = Math.max(...noisy);
    const norm = noisy.map(v=>(v-min)/(max-min||1));

    let X=[], Y=[];
    for(let i=0;i<norm.length-period;i++){
        X.push(norm.slice(i,i+period).map(v=>[v]));
        Y.push([norm[i+period]]);
    }
    if(X.length===0) return data[data.length-1];

    const xs = tf.tensor3d(X);
    const ys = tf.tensor2d(Y);

    const model = tf.sequential();
    model.add(tf.layers.lstm({units:12,inputShape:[period,1]}));
    model.add(tf.layers.dense({units:1}));
    model.compile({optimizer:"adam",loss:"meanSquaredError"});

    await model.fit(xs,ys,{epochs:5,verbose:0});

    const p = model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0];
    return p*(max-min)+min;
}

// ================= Konfidenz =================
function getConfidence(diff){
    return Math.abs(diff)>0.1?"Hoch":Math.abs(diff)>0.05?"Mittel":"Niedrig";
}

// ================= Tabelle und Chart =================
async function displayTable(symbol, hist, preds){
    const out = document.getElementById("out");
    let html = "";
    const now = new Date();
    const timeStr = now.toLocaleString();

    preds.forEach((p,i)=>{
        const diff = (p - hist[hist.length-1])/hist[hist.length-1];
        const sig = diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
        html += `<tr><td>KI${i+1}</td><td>${p.toFixed(2)}</td><td class="${sig.toLowerCase()}">${sig}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${getConfidence(diff)}</td><td>${timeStr}</td></tr>`;
    });

    const avg = preds.reduce((a,b)=>a+b,0)/preds.length;
    const diff = (avg - hist[hist.length-1])/hist[hist.length-1];
    const sig = diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
    html += `<tr><td>Durchschnitt</td><td>${avg.toFixed(2)}</td><td class="${sig.toLowerCase()}">${sig}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${getConfidence(diff)}</td><td>${timeStr}</td></tr>`;

    out.innerHTML = html;
}

// ================= Chart =================
function drawChart(hist, preds){
    if(chart) chart.destroy();
    const avg = preds.reduce((a,b)=>a+b,0)/preds.length;

    chart = new Chart(document.getElementById("chart"),{
        type:'line',
        data:{
            labels:hist.map((_,i)=>`T${i+1}`),
            datasets:[
                {label:"KI1",data:[...Array(hist.length-1).fill(null), preds[0]], borderColor:"#22c55e",fill:false},
                {label:"KI2",data:[...Array(hist.length-1).fill(null), preds[1]], borderColor:"#3b82f6",fill:false},
                {label:"KI3",data:[...Array(hist.length-1).fill(null), preds[2]], borderColor:"#f97316",fill:false},
                {label:"KI4",data:[...Array(hist.length-1).fill(null), preds[3]], borderColor:"#facc15",fill:false},
                {label:"Durchschnitt",data:[...Array(hist.length-1).fill(null), avg],borderColor:"#ffffff",fill:false},
            ]
        },
        options:{responsive:true, maintainAspectRatio:true}
    });
}
</script>
<script>
// ================= Analyse starten =================
async function run(){
    const symbol = selectStock.value;
    if(!symbol){ alert("Bitte ein Asset auswÃ¤hlen!"); return; }

    const status = document.getElementById("status");
    const progressText = document.getElementById("progressText");
    const progressBar = document.getElementById("progressBar");
    status.textContent = "Analyse lÃ¤uftâ€¦";
    progressText.textContent = "Berechnung startet...";
    progressBar.value = 0;

    try{
        const quote = await fetchQuote(symbol);
        const fx = await fetchUsdChf();
        const priceChf = quote*fx;
        document.getElementById("currentPrice").textContent = `Aktueller Kurs: ${priceChf.toFixed(2)} CHF`;

        const basePeriod = parseInt(document.getElementById("timeRange").value);
        document.getElementById("period").textContent = `ðŸ“… KI-Prognose fÃ¼r +${basePeriod} Handelstage`;

        const hist = await fetchHistoricalData(symbol, basePeriod*2);

        const preds = [];
        for(let i=0;i<4;i++){
            preds[i] = await predictLSTM(hist, basePeriod + i*2);
            progressBar.value = ((i+1)/4)*100;
            progressText.textContent = `KI${i+1} fertig (${progressBar.value.toFixed(1)}%)`;
        }

        drawChart(hist, preds);
        displayTable(symbol, hist, preds);

        status.textContent = "Fertig";

    }catch(err){
        status.textContent = "Fehler: "+err;
    }
}

// ================= Automatische Updates =================
let autoInterval = null;
function startAutoUpdate(){
    if(autoInterval) clearInterval(autoInterval);
    autoInterval = setInterval(() => {
        if(selectStock.value) run();
    }, 5*60*1000); // alle 5 Minuten automatisch aktualisieren
}

// ================= Initialisierung =================
window.addEventListener("load", ()=>{
    selectStock.addEventListener("change", ()=>{
        if(selectStock.value){
            startLivePrice(selectStock.value);
            run();
        }
    });
    startAutoUpdate();
});
</script>
</body>
</html>
