<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Dashboard – CHF</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial,sans-serif;margin:0;padding:15px}
h1{text-align:center;font-size:1.5rem;margin-bottom:2px}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:8px}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
.status{text-align:center;margin:10px;font-weight:bold;font-size:0.9rem}
canvas{max-width:100%;margin:18px auto;display:block;background:#020617;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:10px}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.progress-container{width:80%;margin:0 auto;text-align:center}
#currentPrice{margin:8px 0;font-weight:bold;text-align:center;font-size:1rem}
</style>
</head>
<body>

<h1>Multi-KI Aktien & Krypto Dashboard</h1>
<div class="subtitle">Live-Daten, KI-Prognosen & Historie (CHF)</div>
<div id="currentPrice">Aktueller Kurs: –</div>

<div class="controls">
  <select id="stock"></select>
  <select id="timeRange">
    <option value="20">1 Monat</option>
    <option value="40">2 Monate</option>
    <option value="120">6 Monate</option>
    <option value="240">1 Jahr</option>
  </select>
</div>

<div class="status" id="status">Bereit</div>
<div class="progress-container">
  <progress id="progressBar" value="0" max="100"></progress>
  <div id="progressText">Warte auf Berechnung…</div>
</div>

<canvas id="chart" height="280"></canvas>

<table>
<thead>
<tr>
<th>KI</th><th>Prognose (CHF)</th><th>Signal</th><th>Δ %</th><th>Konfidenz</th>
</tr>
</thead>
<tbody id="out"></tbody>
</table>

<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
const selectStock=document.getElementById("stock");
const progressBar=document.getElementById("progressBar");
const progressText=document.getElementById("progressText");
const currentPriceDiv=document.getElementById("currentPrice");
let chart=null, liveInterval=null, fxRate=0;

const ASSETS=[
  {symbol:"AAPL",name:"Apple"},{symbol:"MSFT",name:"Microsoft"},{symbol:"NVDA",name:"NVIDIA"},
  {symbol:"AMZN",name:"Amazon"},{symbol:"GOOGL",name:"Alphabet"},{symbol:"TSLA",name:"Tesla"},
  {symbol:"META",name:"Meta"},
  {symbol:"BTC-USD",name:"Bitcoin"},{symbol:"ETH-USD",name:"Ethereum"},{symbol:"BNB-USD",name:"Binance Coin"},
  {symbol:"SOL-USD",name:"Solana"},{symbol:"ADA-USD",name:"Cardano"},{symbol:"DOGE-USD",name:"Dogecoin"},
  {symbol:"XRP-USD",name:"Ripple"},{symbol:"LTC-USD",name:"Litecoin"}
];

// --- USD → CHF ---
async function fetchUsdChf(){ try{ const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF"); const j=await r.json(); return Number(j?.rates?.CHF)||0.93;}catch{return 0.93;}}

// --- Asset prüfen und Dropdown füllen ---
async function initAssets(){
  selectStock.innerHTML="";
  progressText.textContent="Prüfe Assets...";
  for(let i=0;i<ASSETS.length;i++){
    const sym=ASSETS[i].symbol;
    let available=false;
    try{
      if(sym.includes("USD")){
        const now=Math.floor(Date.now()/1000);
        const res=await fetch(`https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${now-2*24*60*60}&to=${now}&token=${API_KEY}`);
        const data=await res.json();
        if(data.s==="ok" && data.c?.length>0) available=true;
      }else{
        const res=await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${API_KEY}`);
        const data=await res.json();
        if(data.name) available=true;
      }
    }catch{}
    if(available){
      const o=document.createElement("option");
      o.value=sym;
      o.textContent=`${ASSETS[i].name} (${sym})`;
      selectStock.appendChild(o);
    }
  }
  progressText.textContent="Fertig! Wähle ein Asset.";
  if(selectStock.options.length>0){
    selectStock.selectedIndex=0;
    run(); // Direkt starten
  }
}

// --- Aktueller Kurs ---
async function fetchQuote(sym){
  try{
    if(sym.includes("USD")){
      const now=Math.floor(Date.now()/1000);
      const r=await fetch(`https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${now-1*24*60*60}&to=${now}&token=${API_KEY}`);
      const data=await r.json();
      if(data.s==="ok") return Number(data.c.at(-1));
    }else{
      const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`);
      const data=await r.json();
      if(data && data.c) return Number(data.c);
    }
  }catch{}
  return null;
}

async function startLivePrice(sym){
  fxRate=await fetchUsdChf();
  async function update(){ const price=await fetchQuote(sym); if(price!==null) currentPriceDiv.textContent=`Aktueller Kurs: ${(price*fxRate).toFixed(2)} CHF`; }
  await update();
  if(liveInterval) clearInterval(liveInterval);
  liveInterval=setInterval(update,5000);
}

// --- Historische Daten ---
async function fetchHistoricalData(sym,days){
  const now=Math.floor(Date.now()/1000);
  const start=now-days*24*60*60;
  try{
    const url=sym.includes("USD") 
      ? `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`
      : `https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`;
    const r=await fetch(url);
    const data=await r.json();
    if(data.s==="ok" && data.c?.length>0) return data.c.map(Number);
  }catch{}
  return Array(days).fill(100);
}

// --- KI-Prognose ---
async function predictLSTM(data,period){
  const noisy=data.map(v=>v*(1+(Math.random()-0.5)/100));
  const min=Math.min(...noisy), max=Math.max(...noisy);
  const norm=noisy.map(v=>(v-min)/(max-min||1));
  let X=[], Y=[];
  for(let i=0;i<norm.length-period;i++){ X.push(norm.slice(i,i+period).map(v=>[v])); Y.push([norm[i+period]]);}
  if(X.length===0) return data[data.length-1];
  const xs=tf.tensor3d(X), ys=tf.tensor2d(Y);
  const model=tf.sequential();
  model.add(tf.layers.lstm({units:12,inputShape:[period,1]}));
  model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:"adam",loss:"meanSquaredError"});
  await model.fit(xs,ys,{epochs:5,verbose:0});
  return model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0]*(max-min)+min;
}

// --- Signal & Konfidenz ---
function getConfidence(diff){ return Math.abs(diff)>0.1?"Hoch":Math.abs(diff)>0.05?"Mittel":"Niedrig"; }
function drawChart(hist,preds){
  if(chart) chart.destroy();
  const avg=preds.reduce((a,b)=>a+b,0)/preds.length;
  chart=new Chart(document.getElementById("chart"),{
    type:'line',
    data:{
      labels:hist.map((_,i)=>`T${i+1}`),
      datasets:[
        {label:"KI1",data:[...Array(hist.length-1).fill(null), preds[0]*fxRate], borderColor:"#22c55e",fill:false},
        {label:"KI2",data:[...Array(hist.length-1).fill(null), preds[1]*fxRate], borderColor:"#3b82f6",fill:false},
        {label:"KI3",data:[...Array(hist.length-1).fill(null), preds[2]*fxRate], borderColor:"#f97316",fill:false},
        {label:"KI4",data:[...Array(hist.length-1).fill(null), preds[3]*fxRate], borderColor:"#facc15",fill:false},
        {label:"Durchschnitt",data:[...Array(hist.length-1).fill(null), avg*fxRate], borderColor:"#ffffff",fill:false},
      ]
    }
  });
}
function displayTable(hist,preds){
  const out=document.getElementById("out");
  let html="";
  const lastPrice=hist[hist.length-1];
  preds.forEach((p,i)=>{
    const diff=(p-lastPrice)/lastPrice;
    const sig=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
    html+=`<tr><td>KI${i+1}</td><td>${(p*fxRate).toFixed(2)}</td><td class="${sig.toLowerCase()}">${sig}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${getConfidence(diff)}</td></tr>`;
  });
  out.innerHTML=html;
}

// --- Analyse starten ---
async function run(){
  const sym=selectStock.value;
  const period=parseInt(document.getElementById("timeRange").value);
  progressBar.value=0; progressText.textContent="Analyse läuft…"; 
  const hist=await fetchHistoricalData(sym,period*2); progressBar.value=30;
  const preds=[];
  for(let i=0;i<4;i++){ preds[i]=await predictLSTM(hist,period+i*2); progressBar.value=30+15*i; }
  drawChart(hist,preds); displayTable(hist,preds); progressBar.value=100; progressText.textContent="Fertig ✔";
  startLivePrice(sym);
}

// --- Direkt beim Laden starten ---
window.addEventListener("load",()=>initAssets());
</script>

</body>
</html>
