<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>KI Aktien Analyse ‚Äì Finnhub</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:Arial,sans-serif;
  padding:20px;
}
h1{text-align:center}
select,button{
  padding:10px;
  margin:6px;
  background:#020617;
  color:#fff;
  border:1px solid #22c55e;
  border-radius:6px;
}
button:hover{background:#22c55e;color:#000;cursor:pointer}
#loader{text-align:center;color:#38bdf8;margin-top:10px}
.card{
  background:#020617;
  padding:14px;
  border-radius:8px;
  margin-top:12px;
}
.good{color:#22c55e}
.mid{color:#facc15}
.bad{color:#ef4444}
canvas{margin-top:20px}
</style>
</head>

<body>

<h1>Aktien Analyse</h1>
<p style="text-align:center">Echte Daten ‚Ä¢ Quant-Logik ‚Ä¢ Lern-Tool</p>

<div style="text-align:center">
  <select id="stock">
    <option>Lade Aktien‚Ä¶</option>
  </select><br>
  <button onclick="loadStocks()">üîÑ Neu laden</button>
  <button onclick="runAnalysis()">üìä Analyse starten</button>
</div>

<div id="loader">‚Äì</div>
<div id="result" class="card" style="display:none"></div>

<canvas id="chart" height="260"></canvas>

<script>
/* ============================
   API
============================ */
const API_KEY = "d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";

/* ============================
   Aktien Pool (stabil)
============================ */
const STOCK_POOL = [
"AAPL","MSFT","GOOGL","AMZN","META","NVDA","TSLA","JPM",
"V","MA","KO","PEP","WMT","DIS","INTC","ORCL","CSCO",
"IBM","ADBE","NFLX"
];

/* ============================
   DOM
============================ */
const selectStock = document.getElementById("stock");
const loader = document.getElementById("loader");
const resultBox = document.getElementById("result");
let chart = null;

/* ============================
   Utils
============================ */
const shuffle = a => a.sort(()=>Math.random()-0.5);

/* ============================
   Historische Daten ‚â•100 Tage
============================ */
async function fetchHistory(symbol){
  const now = Math.floor(Date.now()/1000);
  const from = now - 160*86400;

  const r = await fetch(
    `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
  );
  const j = await r.json();

  if(j.s==="ok" && j.c.length>=100) return j.c;
  throw "Keine Historie";
}

/* ============================
   Aktien laden
============================ */
async function loadStocks(){
  selectStock.innerHTML="<option>Suche Aktien‚Ä¶</option>";
  loader.textContent="üîç Pr√ºfe Finnhub Historie‚Ä¶";
  selectStock.innerHTML="<option value=''>Aktie w√§hlen</option>";

  let found = 0;

  for(const s of shuffle([...STOCK_POOL])){
    loader.textContent=`Pr√ºfe ${s}‚Ä¶`;
    try{
      await fetchHistory(s);
      const o=document.createElement("option");
      o.value=s;
      o.textContent=s;
      selectStock.appendChild(o);
      found++;
      if(found>=10) break;
    }catch{}
  }

  loader.textContent = found
    ? `‚úÖ ${found} Aktien verf√ºgbar`
    : "‚ùå Keine Aktien gefunden (API-Limit?)";
}

/* ============================
   ECHTE KI / Quant-Analyse
============================ */
function aiCheck(prices){
  const mean=a=>a.reduce((x,y)=>x+y)/a.length;
  const std=a=>{
    const m=mean(a);
    return Math.sqrt(mean(a.map(x=>(x-m)**2)));
  };
  const EMA=(a,p)=>{
    const k=2/(p+1); let e=a[0];
    for(let i=1;i<a.length;i++) e=a[i]*k+e*(1-k);
    return e;
  };

  const last=prices.at(-1);
  const perf30=(last-prices.at(-30))/prices.at(-30)*100;
  const perf90=(last-prices.at(-90))/prices.at(-90)*100;
  const vol=std(prices.slice(-30));
  const ema20=EMA(prices.slice(-60),20);
  const ema50=EMA(prices.slice(-60),50);

  let score=50;
  if(ema20>ema50) score+=15;
  if(last>ema20) score+=10;
  if(perf30>0) score+=10;
  if(perf90>5) score+=10;
  if(vol<mean(prices)*0.03) score+=10;
  if(vol>mean(prices)*0.07) score-=15;

  score=Math.max(0,Math.min(100,score));

  const verdict =
    score>=80?"üü¢ Investierbar":
    score>=60?"üü° Beobachten":
    score>=40?"üü† Schwach":"üî¥ Meiden";

  return {score,verdict,perf30,perf90,vol};
}

/* ============================
   Analyse starten
============================ */
async function runAnalysis(){
  const sym = selectStock.value;
  if(!sym) return alert("Bitte Aktie w√§hlen");

  loader.textContent="üìà Analyse l√§uft‚Ä¶";
  resultBox.style.display="none";

  try{
    const prices = await fetchHistory(sym);
    const ai = aiCheck(prices);

    resultBox.innerHTML = `
      <b>Aktie:</b> ${sym}<br>
      <b>KI-Score:</b> ${ai.score}/100<br>
      <b>Status:</b> ${ai.verdict}<br><br>
      30T Performance: ${ai.perf30.toFixed(2)}%<br>
      90T Performance: ${ai.perf90.toFixed(2)}%<br>
      Risiko (Volatilit√§t): ${ai.vol.toFixed(2)}
    `;
    resultBox.style.display="block";

    drawChart(prices);
    loader.textContent="‚úÖ Analyse abgeschlossen";
  }catch{
    loader.textContent="‚ùå Analyse fehlgeschlagen";
  }
}

/* ============================
   Chart
============================ */
function drawChart(data){
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"),{
    type:"line",
    data:{
      labels:data.map((_,i)=>i),
      datasets:[{
        label:"Kurs",
        data:data,
        borderColor:"#38bdf8",
        fill:false
      }]
    },
    options:{responsive:true}
  });
}

/* ============================
   Start
============================ */
loadStocks();
</script>

</body>
</html>
