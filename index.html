<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aktienanalyse</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;padding:15px}
h1{text-align:center}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem}
.controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
canvas{background:#020617;border-radius:10px;margin-top:15px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:0.85rem}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.warning{color:#f87171;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.footer{text-align:center;font-size:0.75rem;color:#94a3b8;margin-top:12px}
progress{width:80%;height:16px}
.bestKI{background-color:#22c55e33;}
#currentPrice{margin:8px 0;font-weight:bold;text-align:center;font-size:1rem}
#buyLink{margin-top:4px;padding:6px 12px;border-radius:6px;border:1px solid #22c55e;background:#020617;color:#e5e7eb}
#buyLink:hover{background:#22c55e;color:#020617;cursor:pointer}
</style>
</head>

<body>

<h1>Multi-KI Aktienanalyse</h1>
<div class="subtitle">Realistische Prognosen vom aktuellen Kurs jeder Aktie ¬∑ Beste KI markiert</div>

<div class="controls">
<select id="stock"></select>

<select id="forecastRange">
<option value="1">24h</option>
<option value="5">1 Woche</option>
<option value="22">1 Monat</option>
<option value="66">3 Monate</option>
<option value="132">6 Monate</option>
<option value="264">1 Jahr</option>
<option value="1320">5 Jahre</option>
</select>

<button onclick="run()">Analyse starten</button>
</div>

<div id="status">Bereit</div>
<div id="currentPrice"></div>
<div style="text-align:center">
<button id="buyLink" onclick="window.open(getBuyLink(stock.value),'_blank')">Aktie kaufen</button>
</div>

<div style="text-align:center">
<progress id="progressBar" value="0" max="100"></progress>
<div id="progressText"></div>
</div>

<canvas id="chart" height="260"></canvas>

<table>
<thead>
<tr>
<th>KI</th>
<th>Prognose</th>
<th>Signal</th>
<th>Œî %</th>
<th>Konfidenz</th>
<th>Warnung</th>
<th>Backtest</th>
<th>Aktion</th>
<th>Stop / Ziel</th>
</tr>
</thead>
<tbody id="out"></tbody>
</table>

<div class="footer">‚ö†Ô∏è Analyse-Tool ‚Äì keine Anlageberatung</div>

<script>
const API_KEY = "d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart = null;
let priceInterval = null;

const STOCKS = [
 {symbol:"AAPL",name:"Apple"},
 {symbol:"MSFT",name:"Microsoft"},
 {symbol:"NVDA",name:"NVIDIA"},
 {symbol:"AMZN",name:"Amazon"},
 {symbol:"GOOGL",name:"Alphabet"},
 {symbol:"TSLA",name:"Tesla"},
 {symbol:"META",name:"Meta"}
];

const sel = document.getElementById("stock");
STOCKS.forEach(s=>{
 const o=document.createElement("option");
 o.value=s.symbol;
 o.textContent=s.name+" ("+s.symbol+")";
 sel.appendChild(o);
});

function updateProgress(p,text){
 document.getElementById("progressBar").value=p;
 document.getElementById("progressText").textContent=text;
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function getBuyLink(sym){return `https://www.tradingview.com/symbols/${sym}/`;}
</script>
<script>
/* =======================
   DATENABRUF
======================= */
async function fetchHist(sym, days = 365){
    const now = Math.floor(Date.now()/1000);
    const from = now - days * 86400;
    try{
        const r = await fetch(
            `https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
        );
        const j = await r.json();
        if(j.s === "ok" && j.c && j.c.length >= 60){
            return j.c.map(v => Number(v)).filter(v => v > 0);
        }
    }catch(e){
        console.warn("API-Fehler, nutze Fallback", e);
    }
    return generateFallbackHistory(days);
}

function generateFallbackHistory(days){
    let base = 100;
    const arr = [];
    for(let i=0;i<days;i++){
        base *= 1 + 0.002*(Math.sin(i/5));
        arr.push(base);
    }
    return arr;
}

async function fetchPrice(sym){
    try{
        const r = await fetch(
            `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`
        );
        const j = await r.json();
        if(j && j.c) return j.c;
    }catch{}
    return null;
}

/* =======================
   ANALYSE-FUNKTIONEN
======================= */
function trend(h){
    const short = h.slice(-20);
    const long  = h.slice(-100);
    const s = short.reduce((a,b)=>a+b,0)/short.length;
    const l = long.reduce((a,b)=>a+b,0)/long.length;
    return (s - l) / l;
}

function volatility(h){
    const avg = h.reduce((a,b)=>a+b,0)/h.length;
    return Math.sqrt(h.reduce((a,b)=>a + Math.pow(b-avg,2),0) / h.length) / avg;
}

function backtest(h){
    let error=0;
    const n=Math.min(60,h.length-1);
    for(let i=h.length-n;i<h.length-1;i++){
        const pred=h[i]*(1+trend(h.slice(0,i)));
        error += Math.min(Math.abs((pred-h[i+1])/h[i+1]),1);
    }
    return Math.max(0,((1-error/n)*100)).toFixed(1)+"%";
}

function calcConfidence(hist){
    const vol = volatility(hist);
    const bt  = parseFloat(backtest(hist))/100;
    let conf = 0.5 + (0.3 * bt) + (0.2 * (1 - vol));
    if(conf>1) conf=1;
    return conf;
}

function calcWarning(hist){
    const vol = volatility(hist);
    const tr = trend(hist);
    if(vol>0.06) return "‚ö†Ô∏è Hohe Volatilit√§t";
    if(tr>0.15 || tr<-0.15) return "‚ö†Ô∏è Starker Trend";
    return "";
}

function decision(curr,fut,h){
    const t=trend(h);
    const v=volatility(h);
    const bt=parseFloat(backtest(h))/100;
    if(v>0.06 || bt<0.5) return ["üü° WARTEN","Volatilit√§t oder schlechte Historie"];
    if(fut>curr*1.03 && t>0) return ["üü¢ KAUFEN","Aufw√§rtstrend best√§tigt"];
    if(fut<curr*0.97 && t<0) return ["üî¥ VERKAUFEN","Abw√§rtstrend best√§tigt"];
    return ["‚ö™ HALTEN","Keine klare Richtung"];
}

function risk(curr,h){
    const v=volatility(h)*curr;
    return {sl: (curr-2*v).toFixed(2), tp: (curr+3*v).toFixed(2)};
}

/* =======================
   REALISTISCHE KI-PROGNOSE
======================= */
function forecast(hist, days, idx, currentPrice){
    let price = currentPrice;      
    const t = trend(hist);         
    const vol = volatility(hist);  
    const decay = 0.95;            
    const histMax = Math.max(...hist);
    const histMin = Math.min(...hist);
    const result = [];

    for(let i=0;i<days;i++){
        const factor = t*(1+idx*0.05) * Math.pow(decay, i/30);
        const histEffect = ((histMax - price)/(histMax - histMin)) * vol * 0.5;
        price *= 1 + factor + histEffect;

        const lower = histMin*0.9;
        const upper = histMax*1.1;
        price = Math.max(lower, Math.min(upper, price));

        result.push(price);
    }
    return result;
}

/* =======================
   CHART
======================= */
function draw(hist, futs){
    if(chart) chart.destroy();

    const labels = [];
    for(let i=hist.length;i>0;i--) labels.push("-"+i);
    for(let i=1;i<=futs[0].length;i++) labels.push("+"+i);

    const datasets = [{
        label: "Historie",
        data: hist,
        borderColor: "#3b82f6",
        fill: false
    }];

    const colors = ["#22c55e","#facc15","#f97316","#38bdf8"];
    futs.forEach((f,i)=>{
        datasets.push({
            label: "KI "+(i+1),
            data: [...Array(hist.length).fill(null), ...f],
            borderColor: colors[i],
            fill: false,
            pointRadius: 2
        });
    });

    chart = new Chart(document.getElementById("chart"),{
        type: "line",
        data: {labels, datasets},
        options: {animation:false,responsive:true}
    });
}

/* =======================
   BESTE KI MARKIEREN
======================= */
function markBestKI(){
    const rows = document.querySelectorAll("#out tr");
    if(rows.length === 0) return;

    let bestValue=-Infinity;
    let bestRow=null;
    rows.forEach(row=>{
        const val=parseFloat(row.cells[1].textContent);
        if(val>bestValue){bestValue=val;bestRow=row;}
        row.classList.remove("bestKI");
    });
    if(bestRow) bestRow.classList.add("bestKI");
}

/* =======================
   AKTUELLER KURS
======================= */
function startPriceInterval(){
    if(priceInterval) clearInterval(priceInterval);
    updateCurrentPrice(sel.value);
    priceInterval = setInterval(()=>updateCurrentPrice(sel.value),5000);
}

async function updateCurrentPrice(sym){
    const price = await fetchPrice(sym);
    if(price){
        document.getElementById("currentPrice").textContent=
            `Aktueller Kurs ${sym}: ${price.toFixed(2)} USD`;
    }
}

/* =======================
   RUN
======================= */
async function run(){
    try{
        updateProgress(0,"Starte Analyse‚Ä¶");
        document.getElementById("status").textContent="Analyse l√§uft‚Ä¶";

        const sym = sel.value;
        const days = +document.getElementById("forecastRange").value;

        updateProgress(10,"Lade historische Daten‚Ä¶");
        const hist = await fetchHist(sym);
        await sleep(150);

        updateProgress(25,"Lade aktuellen Kurs‚Ä¶");
        const price = await fetchPrice(sym) || hist[hist.length-1];
        await sleep(100);

        const futs=[];
        for(let i=0;i<4;i++){
            updateProgress(35+i*15,`KI ${i+1} berechnet Prognose‚Ä¶`);
            const f=forecast(hist,days,i,price);
            futs.push(f);
            await sleep(100);
        }

        updateProgress(85,"Erstelle Diagramm‚Ä¶");
        draw(hist,futs);

        updateProgress(92,"Erstelle Tabelle‚Ä¶");
        let html="";
        futs.forEach((f,i)=>{
            const last=f[f.length-1];
            const dec=decision(price,last,hist);
            const r=risk(price,hist);
            const conf=(calcConfidence(hist)*100).toFixed(0);
            const warn=calcWarning(hist);

            html+=`
            <tr>
                <td>KI${i+1}</td>
                <td>${last.toFixed(2)}</td>
                <td class="${last>price?'buy':'sell'}">${last>price?'‚Üë':'‚Üì'}</td>
                <td>${((last-price)/price*100).toFixed(2)}%</td>
                <td class="conf">${conf}%</td>
                <td class="warning">${warn}</td>
                <td>${backtest(hist)}</td>
                <td><b>${dec[0]}</b><br>${dec[1]}</td>
                <td>üõë ${r.sl}<br>üéØ ${r.tp}</td>
            </tr>`;
        });
        document.getElementById("out").innerHTML=html;
        markBestKI();
        startPriceInterval();

        updateProgress(100,"Analyse abgeschlossen ‚úî");
        document.getElementById("status").textContent="Fertig";

    }catch(err){
        console.error(err);
        updateProgress(0,"Fehler");
        document.getElementById("status").textContent="Fehler: "+err;
    }
}
</script>

</body>
</html>
