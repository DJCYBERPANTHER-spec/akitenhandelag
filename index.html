<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aktien Handel AG â€“ Multi-Asset Analyse</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body {background:#0c0f1a;color:#e5e7eb;font-family:sans-serif;margin:0;padding:0;}
header {position:fixed;top:0;left:0;right:0;height:100px;background:#11151f;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;}
header h1{margin:0;font-size:1.8rem;}
header .subtitle{font-size:1rem;color:#94a3b8;}
.container{position:absolute;top:100px;bottom:50px;left:0;right:0;padding:15px;overflow-y:auto;}
.card{background:#11151f;border:1px solid #1f2937;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px;}
select,button{padding:8px 12px;border-radius:6px;border:1px solid #22c55e;background:#0e111b;color:#e5e7eb;cursor:pointer;}
select:hover,button:hover{background:#161b2c;}
canvas{background:#0e111b;border-radius:10px;display:block;margin:10px auto;}
table{width:100%;border-collapse:collapse;font-size:0.85rem;}
th,td{border:1px solid #22c55e;padding:6px;text-align:center;}
.scrollable-table{max-height:250px;overflow-y:auto;}
footer{position:fixed;bottom:0;left:0;right:0;height:50px;background:#11151f;color:#94a3b8;display:flex;align-items:center;justify-content:center;font-size:0.75rem;}
</style>
</head>
<body>

<header>
<h1>ðŸ”¹ Aktien Handel AG â€“ Multi-Asset Analyse</h1>
<div class="subtitle">Live Kurse + KI-Prognosen</div>
</header>

<div class="container">

<div class="card">
<h2>ðŸ“Œ Multi-Asset Auswahl</h2>
<div class="controls">
<select id="multiSelect" multiple size="5">
<option value="AAPL">Apple (AAPL)</option>
<option value="MSFT">Microsoft (MSFT)</option>
<option value="GOOGL">Alphabet (GOOGL)</option>
<option value="BTCUSDT">Bitcoin (BTCUSDT)</option>
<option value="ETHUSDT">Ethereum (ETHUSDT)</option>
</select>
<button onclick="loadMultiAssets()">Laden</button>
</div>
<div id="statusMulti">Status: Bereit</div>
</div>

<div class="card" style="height:300px;">
<h2>ðŸ’¹ Chart</h2>
<canvas id="chart" height="260" style="width:100%; height:260px;"></canvas>
</div>

<div class="card scrollable-table">
<h2>ðŸ“Š Tabelle</h2>
<table>
<thead><tr><th>Asset</th><th>Kurs / Prognose</th></tr></thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<footer>Â© Aktien Handel AG</footer>

<script>
const FINNHUB_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let multiChart=null;
let selectedAssets=[];
let liveInterval=null;
let kiInterval=null;

// ================== Hilfsfunktionen ==================
function generateDummyData(days=30){
    const now=new Date();
    let data=[], labels=[];
    for(let i=days-1;i>=0;i--){
        const d=new Date(now); d.setDate(now.getDate()-i);
        labels.push(d.toISOString().slice(0,10));
        data.push((Math.random()*20)+100);
    }
    return {labels,data};
}

async function fetchData(symbol){
    try{
        if(symbol.endsWith("USDT")){
            const res=await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=30`);
            const json=await res.json();
            const data=json.map(x=>parseFloat(x[4]));
            const labels=json.map(x=>new Date(x[0]).toISOString().slice(0,10));
            return {labels,data};
        } else {
            const now=Math.floor(Date.now()/1000);
            const from=now-30*86400;
            const res=await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${now}&token=${FINNHUB_KEY}`);
            const json=await res.json();
            if(json.s!=="ok") throw "Keine Daten";
            return {labels:json.t.map(t=>new Date(t*1000).toISOString().slice(0,10)), data:json.c};
        }
    } catch(e){
        console.log("API Fehler",e);
        return generateDummyData(30);
    }
}

// ================== LSTM KI ==================
async function predictLSTM(prices,lookback=10){
    try{
        const normMin=Math.min(...prices);
        const normMax=Math.max(...prices);
        const norm=prices.map(v=>(v-normMin)/(normMax-normMin||1));
        let X=[],Y=[];
        for(let i=0;i<norm.length-lookback;i++){
            X.push(norm.slice(i,i+lookback).map(v=>[v]));
            Y.push([norm[i+lookback]]);
        }
        if(X.length===0) return prices[prices.length-1];
        const xs=tf.tensor3d(X);
        const ys=tf.tensor2d(Y);
        const model=tf.sequential();
        model.add(tf.layers.lstm({units:12,inputShape:[lookback,1]}));
        model.add(tf.layers.dense({units:1}));
        model.compile({optimizer:"adam",loss:"meanSquaredError"});
        await model.fit(xs,ys,{epochs:5,verbose:0});
        const pred=model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0];
        return pred*(normMax-normMin)+normMin;
    } catch(e){console.log("LSTM Fehler",e); return prices[prices.length-1];}
}

// ================== Multi-Asset Laden ==================
async function loadMultiAssets(){
    const sel=document.getElementById("multiSelect");
    const options=[...sel.selectedOptions].map(o=>o.value);
    if(options.length===0) return alert("Bitte Assets auswÃ¤hlen!");
    document.getElementById("statusMulti").textContent="Lade Assetsâ€¦";

    selectedAssets.length=0;
    for(const sym of options){
        const res=await fetchData(sym);
        const preds=[];
        for(let i=0;i<4;i++) preds[i]=await predictLSTM(res.data,10+i*2);
        selectedAssets.push({symbol:sym,labels:res.labels,prices:res.data,preds});
    }

    drawMultiChart();
    displayMultiTable();
    document.getElementById("statusMulti").textContent="Fertig!";

    // Live-Update alle 5s
    if(liveInterval) clearInterval(liveInterval);
    liveInterval=setInterval(updateLivePrices,5000);

    // KI-Update alle 60s
    if(kiInterval) clearInterval(kiInterval);
    kiInterval=setInterval(updateKIPrognosen,60000);
}

// ================== Chart ==================
function drawMultiChart(){
    const datasets=[];
    selectedAssets.forEach((a,idx)=>{
        datasets.push({label:a.symbol,data:a.prices,borderColor:getColor(idx),fill:false});
        a.preds.forEach((p,i)=>{
            datasets.push({label:`${a.symbol} KI${i+1}`,data:[...Array(a.prices.length-1).fill(null),p],borderColor:getColor(idx+i+1,true),borderDash:[5,5],fill:false});
        });
    });
    const labels=selectedAssets[0]?.labels||[];
    if(!multiChart){
        multiChart=new Chart(document.getElementById("chart"),{
            type:"line",
            data:{labels,datasets},
            options:{responsive:true,maintainAspectRatio:false,animation:false}
        });
    } else {
        multiChart.data.labels=labels;
        multiChart.data.datasets=datasets;
        multiChart.update();
    }
}

// ================== Tabelle ==================
function displayMultiTable(){
    const tbody=document.getElementById("tableBody");
    tbody.innerHTML="";
    selectedAssets.forEach(a=>{
        const current=a.prices[a.prices.length-1];
        const trCurr=document.createElement("tr");
        trCurr.innerHTML=`<td>${a.symbol} Aktuell</td><td>${current.toFixed(2)}</td>`;
        tbody.appendChild(trCurr);
        a.preds.forEach((p,i)=>{
            const diff=(p-current)/current;
            const sig=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${a.symbol} KI${i+1}</td><td>${p.toFixed(2)} (${sig})</td>`;
            tbody.appendChild(tr);
        });
    });
}

// ================== Live Update ==================
async function updateLivePrices(){
    for(const a of selectedAssets){
        const res=await fetchData(a.symbol);
        a.prices=res.data;
        a.labels=res.labels;
    }
    drawMultiChart();
    displayMultiTable();
}

// ================== KI Update ==================
async function updateKIPrognosen(){
    for(const a of selectedAssets){
        const preds=[];
        for(let i=0;i<4;i++) preds[i]=await predictLSTM(a.prices,10+i*2);
        a.preds=preds;
    }
    drawMultiChart();
    displayMultiTable();
}

// ================== Farbpalette ==================
function getColor(idx,light=false){
    const colors=["#22c55e","#3b82f6","#f97316","#facc15","#ffffff","#8b5cf6","#ec4899","#f43f5e"];
    let c=colors[idx % colors.length];
    if(light) c+="88";
    return c;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>

<script>
async function predictLSTM(prices,lookback=10){
    try{
        const normMin=Math.min(...prices);
        const normMax=Math.max(...prices);
        const norm=prices.map(v=>(v-normMin)/(normMax-normMin||1));

        let X=[],Y=[];
        for(let i=0;i<norm.length-lookback;i++){
            X.push(norm.slice(i,i+lookback).map(v=>[v]));
            Y.push([norm[i+lookback]]);
        }
        if(X.length===0) return prices[prices.length-1];

        const xs=tf.tensor3d(X);
        const ys=tf.tensor2d(Y);

        const model=tf.sequential();
        model.add(tf.layers.lstm({units:12,inputShape:[lookback,1]}));
        model.add(tf.layers.dense({units:1}));
        model.compile({optimizer:"adam",loss:"meanSquaredError"});

        await model.fit(xs,ys,{epochs:5,verbose:0});

        const pred=model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0];
        return pred*(normMax-normMin)+normMin;
    } catch(e){
        console.log("LSTM Fehler:",e);
        return prices[prices.length-1];
    }
}

// ================== NEUE LOAD-ASSET FUNKTION ==================
async function loadAsset(){
    const sel=document.getElementById("assetSelect").value;
    document.getElementById("status").textContent="Lade Datenâ€¦";
    const res=await fetchData(sel);
    document.getElementById("status").textContent="Fertig";

    // KI-Prognosen
    const preds=[];
    for(let i=0;i<4;i++){
        preds[i]=await predictLSTM(res.data,10+i*2); // leicht unterschiedliche Lookback
    }

    // Chart
    if(!chart){
        chart=new Chart(document.getElementById("chart"),{
            type:"line",
            data:{
                labels:res.labels,
                datasets:[
                    {label:sel,data:res.data,borderColor:"#22c55e",fill:false},
                    {label:"KI1",data:[...Array(res.data.length-1).fill(null),preds[0]],borderColor:"#3b82f6",fill:false},
                    {label:"KI2",data:[...Array(res.data.length-1).fill(null),preds[1]],borderColor:"#f97316",fill:false},
                    {label:"KI3",data:[...Array(res.data.length-1).fill(null),preds[2]],borderColor:"#facc15",fill:false},
                    {label:"KI4",data:[...Array(res.data.length-1).fill(null),preds[3]],borderColor:"#ffffff",fill:false}
                ]
            },
            options:{responsive:true,maintainAspectRatio:false,animation:false}
        });
    } else {
        chart.data.labels=res.labels;
        chart.data.datasets[0].data=res.data;
        chart.data.datasets[0].label=sel;
        for(let i=0;i<4;i++){
            chart.data.datasets[i+1].data=[...Array(res.data.length-1).fill(null),preds[i]];
        }
        chart.update();
    }

    // Tabelle
    const tbody=document.getElementById("tableBody");
    tbody.innerHTML="";
    const now=new Date().toLocaleString();
    for(let i=0;i<res.data.length;i++){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${res.labels[i]}</td><td>${res.data[i].toFixed(2)}</td>`;
        tbody.appendChild(tr);
    }
    // KI-Prognosen Zeile hinzufÃ¼gen
    preds.forEach((p,i)=>{
        const tr=document.createElement("tr");
        const diff=(p-res.data[res.data.length-1])/res.data[res.data.length-1];
        const sig=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
        tr.innerHTML=`<td>KI${i+1} Prognose</td><td>${p.toFixed(2)} (${sig})</td>`;
        tbody.appendChild(tr);
    });

    document.getElementById("currentPrice").textContent=`Aktueller Kurs: ${res.data[res.data.length-1].toFixed(2)}`;
}
</script>
<script>
let multiChart=null;
const selectedAssets=[]; // Speichert die geladenen Assets

async function loadMultiAssets(){
    const sel=document.getElementById("multiSelect");
    const options=[...sel.selectedOptions].map(o=>o.value);
    if(options.length===0) return alert("Bitte Assets auswÃ¤hlen!");
    document.getElementById("statusMulti").textContent="Lade Assetsâ€¦";

    selectedAssets.length=0; // reset
    for(const sym of options){
        const res=await fetchData(sym); // gleiche fetchData Funktion wie vorher
        const preds=[];
        for(let i=0;i<4;i++){
            preds[i]=await predictLSTM(res.data,10+i*2);
        }
        selectedAssets.push({symbol:sym,labels:res.labels,prices:res.data,preds});
    }

    drawMultiChart();
    displayMultiTable();
    document.getElementById("statusMulti").textContent="Fertig!";
}

// ================= CHART =================
function drawMultiChart(){
    const datasets=[];
    selectedAssets.forEach((a,idx)=>{
        datasets.push({label:a.symbol,data:a.prices,borderColor:getColor(idx),fill:false});
        a.preds.forEach((p,i)=>{
            datasets.push({label:`${a.symbol} KI${i+1}`,data:[...Array(a.prices.length-1).fill(null),p],borderColor:getColor(idx+i+1,true),borderDash:[5,5],fill:false});
        });
    });
    const labels=selectedAssets[0]?.labels||[];
    if(!multiChart){
        multiChart=new Chart(document.getElementById("chart"),{
            type:"line",
            data:{labels,datasets},
            options:{responsive:true,maintainAspectRatio:false,animation:false}
        });
    } else {
        multiChart.data.labels=labels;
        multiChart.data.datasets=datasets;
        multiChart.update();
    }
}

// ================= TABELLE =================
function displayMultiTable(){
    const tbody=document.getElementById("tableBody");
    tbody.innerHTML="";
    selectedAssets.forEach(a=>{
        const current=a.prices[a.prices.length-1];
        const now=new Date().toLocaleString();
        const trCurr=document.createElement("tr");
        trCurr.innerHTML=`<td>${a.symbol} Aktuell</td><td>${current.toFixed(2)}</td>`;
        tbody.appendChild(trCurr);

        a.preds.forEach((p,i)=>{
            const diff=(p-current)/current;
            const sig=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${a.symbol} KI${i+1}</td><td>${p.toFixed(2)} (${sig})</td>`;
            tbody.appendChild(tr);
        });
    });
}

// ================= Farbpalette =================
function getColor(idx,light=false){
    const colors=["#22c55e","#3b82f6","#f97316","#facc15","#ffffff","#8b5cf6","#ec4899","#f43f5e"];
    let c=colors[idx % colors.length];
    if(light) c+= "88"; // transparent fÃ¼r Prognose
    return c;
}
</script>
