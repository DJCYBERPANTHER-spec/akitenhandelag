<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Aktien & Krypto Dashboard â€“ CHF</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial,sans-serif;margin:0;padding:15px}
h1{text-align:center;font-size:1.5rem;margin-bottom:2px}
.subtitle{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:8px}
.controls{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:12px 0}
select,button{background:#020617;color:#e5e7eb;border:1px solid #22c55e;padding:8px 12px;border-radius:6px;font-size:0.85rem}
button:hover{background:#22c55e;color:#020617;cursor:pointer}
.status{text-align:center;margin:10px;font-weight:bold;font-size:0.9rem}
canvas{max-width:100%;margin:18px auto;display:block;background:#020617;border-radius:10px}
.scrollable-table{max-height:320px;overflow-y:auto;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:10px}
th,td{border:1px solid #22c55e;padding:6px;text-align:center}
.buy{color:#22c55e;font-weight:bold}
.sell{color:#ef4444;font-weight:bold}
.hold{color:#facc15;font-weight:bold}
.warning{color:#f87171;font-weight:bold}
.conf{color:#38bdf8;font-weight:bold}
.footer{text-align:center;margin-top:14px;font-size:0.7rem;color:#94a3b8}
progress{border-radius:5px;width:80%;height:18px}
.chart-panel{width:100%;max-width:100%;height:320px;margin-bottom:20px}
.table-panel{width:100%;max-width:100%;margin-top:10px}
.progress-container{width:80%;margin:0 auto;text-align:center}
.bestKI{background-color:#22c55e33}
#currentPrice{margin:8px 0;font-weight:bold;text-align:center;font-size:1rem}
#buyLink{margin-top:4px;padding:6px 12px;border-radius:6px;border:1px solid #22c55e;background:#020617;color:#e5e7eb}
#buyLink:hover{background:#22c55e;color:#020617;cursor:pointer}
</style>
</head>
<body>

<h1>Multi-KI Aktien & Krypto Dashboard</h1>
<div class="subtitle">Live-Daten, KI-Prognosen & Historie (CHF)</div>
<div class="infoBox" id="currentPrice">Aktueller Kurs: â€“</div>
<div class="period" id="period">Zeitraum: â€“</div>

<div class="controls">
  <select id="stock"></select>
  <select id="timeRange">
    <option value="20">1 Monat</option>
    <option value="40">2 Monate</option>
    <option value="120">6 Monate</option>
    <option value="240">1 Jahr</option>
  </select>
  <button onclick="run()">Analyse starten</button>
  <button onclick="openYahoo()">Yahoo</button>
  <button onclick="openTradingView()">TradingView</button>
  <button onclick="openSwissquote()">Swissquote</button>
</div>

<div class="status" id="status">Bereit</div>
<div class="loader" id="loader">â€“</div>
<div class="progress-container">
  <progress id="progressBar" value="0" max="100"></progress>
  <div id="progressText">Warte auf Berechnungâ€¦</div>
</div>

<div class="chart-panel">
  <canvas id="chart" height="280"></canvas>
</div>

<div class="table-panel">
  <div class="scrollable-table">
    <table>
      <thead>
        <tr>
          <th>KI</th>
          <th>Prognose (CHF)</th>
          <th>Signal</th>
          <th>Î” %</th>
          <th>Konfidenz</th>
          <th>Warnung</th>
          <th>Backtest</th>
          <th>Aktion</th>
          <th>Stop / Ziel</th>
        </tr>
      </thead>
      <tbody id="out"></tbody>
    </table>
  </div>
</div>

<div style="text-align:center">
  <button id="buyLink" onclick="window.open(getBuyLink(stock.value),'_blank')">Kaufen</button>
</div>

<div class="footer">@ AKTIEN HANDEL AG â€“ Keine Anlageberatung</div>

<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let chart=null, liveInterval=null;

// Aktien + Kryptos
const POSSIBLE_ASSETS=[
  {symbol:"AAPL",name:"Apple Inc."},{symbol:"MSFT",name:"Microsoft Corp."},{symbol:"NVDA",name:"NVIDIA Corp."},
  {symbol:"AMZN",name:"Amazon.com Inc."},{symbol:"GOOGL",name:"Alphabet Inc."},{symbol:"TSLA",name:"Tesla Inc."},
  {symbol:"META",name:"Meta Platforms"},{symbol:"BTC-USD",name:"Bitcoin"},{symbol:"ETH-USD",name:"Ethereum"},
  {symbol:"BNB-USD",name:"Binance Coin"},{symbol:"SOL-USD",name:"Solana"},{symbol:"ADA-USD",name:"Cardano"},
  {symbol:"DOGE-USD",name:"Dogecoin"},{symbol:"XRP-USD",name:"Ripple"},{symbol:"LTC-USD",name:"Litecoin"}
];

const selectStock=document.getElementById("stock");
const loader=document.getElementById("loader");

// PrÃ¼fen und Liste fÃ¼llen
async function validateAssetsSequential(){
  selectStock.innerHTML="";
  loader.textContent="PrÃ¼fe Assets...";
  for(let i=0;i<POSSIBLE_ASSETS.length;i++){
    const sym=POSSIBLE_ASSETS[i].symbol;
    loader.textContent=`PrÃ¼fe ${i+1}/${POSSIBLE_ASSETS.length}: ${POSSIBLE_ASSETS[i].name}`;
    try{
      let available=false;
      if(sym.includes("USD")){
        const now=Math.floor(Date.now()/1000);
        const res=await fetch(`https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${now-3*24*60*60}&to=${now}&token=${API_KEY}`);
        const data=await res.json();
        if(data.s==="ok" && data.c?.length>0) available=true;
      }else{
        const res=await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${API_KEY}`);
        const data=await res.json();
        if(data.name) available=true;
      }
      if(available){
        const o=document.createElement("option");
        o.value=sym;
        o.textContent=`${POSSIBLE_ASSETS[i].name} (${sym})`;
        selectStock.appendChild(o);
      }
    }catch{}
  }
  loader.textContent="Fertig! Bitte Asset auswÃ¤hlen.";
}
validateAssetsSequential();

// USDâ†’CHF
async function fetchUsdChf(){try{ const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF"); const j=await r.json(); return Number(j?.rates?.CHF)||0.93;}catch{return 0.93;}}

// Aktueller Preis
async function fetchQuote(sym){
  try{
    let url=sym.includes("USD") ? `https://finnhub.io/api/v1/crypto/candle?symbol=${sym}&resolution=D&from=${Math.floor(Date.now()/1000)-60*24*60*60}&to=${Math.floor(Date.now()/1000)}&token=${API_KEY}` : `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${API_KEY}`;
    const r=await fetch(url); const j=await r.json();
    if(sym.includes("USD") && j.s==="ok") return Number(j.c?.at(-1));
    if(!sym.includes("USD") && j.c!==undefined) return Number(j.c);
  }catch{}
  return 0;
}

// Historische Daten
async function fetchHistoricalData(symbol,period){
  const now=Math.floor(Date.now()/1000);
  const start=now-period*24*60*60;
  try{
    let url=symbol.includes("USD") ? 
      `https://finnhub.io/api/v1/crypto/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}` : 
      `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${start}&to=${now}&token=${API_KEY}`;
    const r=await fetch(url); const j=await r.json();
    if(j.s!=="ok"||!j.c||j.c.length===0) throw "Keine historischen Daten";
    return j.c.map(v=>Number(v));
  }catch{ 
    const q=await fetchQuote(symbol);
    return Array(Math.max(period,30)).fill(q); 
  }
}

// LSTM Prognose
async function predictLSTM(data,period){
  const noisy=data.map(v=>v*(1+(Math.random()-0.5)/100)); 
  const min=Math.min(...noisy), max=Math.max(...noisy); 
  const norm=noisy.map(v=>(v-min)/(max-min||1));
  let X=[], Y=[]; 
  for(let i=0;i<norm.length-period;i++){ X.push(norm.slice(i,i+period).map(v=>[v])); Y.push([norm[i+period]];}
  if(X.length===0)return data[data.length-1];
  const xs=tf.tensor3d(X), ys=tf.tensor2d(Y);
  const model=tf.sequential(); model.add(tf.layers.lstm({units:12,inputShape:[period,1]})); model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:"adam",loss:"meanSquaredError"});
  await model.fit(xs,ys,{epochs:5,verbose:0});
  return model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0]*(max-min)+min;
}

// Kauf-Links
function getBuyLink(sym){return `https://www.tradingview.com/symbols/${sym}/`;}
function openYahoo(){window.open(`https://finance.yahoo.com/quote/${selectStock.value}`,"_blank");}
function openTradingView(){window.open(`https://www.tradingview.com/symbols/${selectStock.value}/`,"_blank");}
function openSwissquote(){window.open(`https://www.swissquote.ch/sqw-en/private/trading/instruments/search?query=${selectStock.value}`,"_blank");}

// Hilfsfunktionen fÃ¼r Tabelle & Chart
function getConfidence(diff){if(Math.abs(diff)>0.1) return "Hoch"; if(Math.abs(diff)>0.05) return "Mittel"; return "Niedrig";}
function getSignal(diff){if(diff>0.05) return "KAUFEN"; if(diff<-0.05) return "VERKAUFEN"; return "HALTEN";}
function backtest(hist){let e=0;const n=Math.min(60,hist.length-1);for(let i=hist.length-n;i<hist.length-1;i++){e+=Math.min(Math.abs((hist[i]-hist[i+1])/hist[i+1]),1);} return Math.max(0,((1-e/n)*100)).toFixed(1)+"%";}
function decision(curr,fut,hist){const diff=(fut-curr)/curr; if(diff>0.03) return ["ðŸŸ¢ KAUFEN","AufwÃ¤rtstrend bestÃ¤tigt"]; if(diff<-0.03) return ["ðŸ”´ VERKAUFEN","AbwÃ¤rtstrend bestÃ¤tigt"]; return ["âšª HALTEN","Keine klare Richtung"];}
function risk(curr,hist){const vol=hist.reduce((a,b)=>a+b,0)/hist.length*0.05; return {sl:(curr-2*vol).toFixed(2),tp:(curr+3*vol).toFixed(2)};}
function drawChart(hist,preds){if(chart) chart.destroy(); const avg=preds.reduce((a,b)=>a+b,0)/preds.length; const labels=hist.map((_,i)=>`T${i+1}`); chart=new Chart(document.getElementById("chart"),{type:'line',data:{labels,datasets:[{label:"KI1",data:[...Array(hist.length-1).fill(null), preds[0]], borderColor:"#22c55e",fill:false},{label:"KI2",data:[...Array(hist.length-1).fill(null), preds[1]], borderColor:"#3b82f6",fill:false},{label:"KI3",data:[...Array(hist.length-1).fill(null), preds[2]], borderColor:"#f97316",fill:false},{label:"KI4",data:[...Array(hist.length-1).fill(null), preds[3]], borderColor:"#facc15",fill:false},{label:"Durchschnitt",data:[...Array(hist.length-1).fill(null), avg],borderColor:"#ffffff",fill:false}]} ,options:{responsive:true, maintainAspectRatio:true}});}
</script>
<script>
// ---------- Live-Kurs aus Yahoo (CHF) ----------
async function fetchCurrentPriceCHF(symbol){
    try{
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
        const res = await fetch(url);
        const data = await res.json();
        const priceUSD = data.chart.result[0].meta.regularMarketPrice;
        const fx = await fetchUsdChf();
        return priceUSD * fx;
    }catch(err){
        console.error("Yahoo-Kurs konnte nicht geladen werden", err);
        return 0;
    }
}

// ---------- Run-Analyse ----------
async function run(){
    const symbol = selectStock.value;
    if(!symbol){ alert("Bitte ein Asset auswÃ¤hlen!"); return; }

    const status = document.getElementById("status");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const periodDiv = document.getElementById("period");

    status.textContent = "Analyse lÃ¤uftâ€¦";
    progressBar.value = 0;
    progressText.textContent = "Starte Analyseâ€¦";

    try{
        // --- Aktueller Kurs CHF ---
        const priceCHF = await fetchCurrentPriceCHF(symbol);
        document.getElementById("currentPrice").textContent = `Aktueller Kurs: ${priceCHF.toFixed(2)} CHF`;

        const basePeriod = parseInt(document.getElementById("timeRange").value);
        periodDiv.textContent = `ðŸ“… KI-Prognose fÃ¼r +${basePeriod} Handelstage`;

        // --- Historische Daten abrufen ---
        progressBar.value = 10; progressText.textContent = "Lade historische Datenâ€¦";
        const hist = await fetchHistoricalData(symbol, basePeriod*2);

        // USDâ†’CHF umrechnen
        let histCHF = hist;
        if(symbol.includes("USD")){
            const fx = await fetchUsdChf();
            histCHF = hist.map(h=>h*fx);
        }

        // --- 4 KI-Prognosen ---
        const preds = [];
        for(let i=0;i<4;i++){
            progressBar.value = 20 + i*20;
            progressText.textContent = `Berechne KI${i+1}â€¦`;
            preds[i] = await predictLSTM(histCHF, basePeriod + i*2);
        }

        // --- Chart zeichnen ---
        progressBar.value = 90; progressText.textContent = "Zeichne Chartâ€¦";
        drawChart(histCHF, preds);

        // --- Tabelle fÃ¼llen ---
        progressBar.value = 95; progressText.textContent = "Erstelle Tabelleâ€¦";
        let html = "";
        const now = new Date().toLocaleString();

        preds.forEach((p,i)=>{
            const diff = (p - histCHF[histCHF.length-1])/histCHF[histCHF.length-1];
            const sig = getSignal(diff);
            const conf = getConfidence(diff);
            const dec = decision(histCHF[histCHF.length-1], p, histCHF);
            const r = risk(histCHF[histCHF.length-1], histCHF);
            const bt = backtest(histCHF);

            html += `<tr>
                <td>KI${i+1}</td>
                <td>${p.toFixed(2)}</td>
                <td class="${sig.toLowerCase()}">${sig}</td>
                <td>${(diff*100).toFixed(1)}%</td>
                <td class="conf">${conf}</td>
                <td class="warning">â€“</td>
                <td>${bt}</td>
                <td><b>${dec[0]}</b><br>${dec[1]}</td>
                <td>ðŸ›‘ ${r.sl}<br>ðŸŽ¯ ${r.tp}</td>
            </tr>`;
        });

        document.getElementById("out").innerHTML = html;

        // Beste KI markieren
        let bestValue = -Infinity, bestRow = null;
        document.querySelectorAll("#out tr").forEach(row=>{
            const val = parseFloat(row.cells[1].textContent);
            if(val>bestValue){ bestValue=val; bestRow=row; }
            row.classList.remove("bestKI");
        });
        if(bestRow) bestRow.classList.add("bestKI");

        // Kauflink aktualisieren
        document.getElementById("buyLink").onclick = ()=> window.open(getBuyLink(symbol),"_blank");

        progressBar.value = 100;
        progressText.textContent = "Analyse abgeschlossen âœ”";
        status.textContent = "Fertig";

    }catch(err){
        console.error(err);
        status.textContent = "Fehler: "+err;
        progressText.textContent = "Fehler bei Analyse";
        progressBar.value = 0;
    }
}

// --- Start bei Seitenaufruf ---
selectStock.addEventListener("change", ()=>run());
</script>
</body>
</html>
