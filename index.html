<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Asset Risiko & Crash Analyse</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#111; color:#eee; padding:20px }
select, button { padding:8px; margin:5px }
#status { margin-top:10px }
.ok { color:#4caf50 }
.warn { color:#ff9800 }
.danger { color:#f44336 }
small { color:#aaa }
</style>
</head>

<body>
<h2>ðŸ“‰ Asset Risiko- & Crash-Analyse</h2>

<div>
<select id="assetSelect"></select>
<button onclick="loadAsset()">Analysieren</button>
</div>

<div id="status">
<b>Status:</b> <span id="searchStatus">Suche Assetsâ€¦</span><br>
GeprÃ¼ft: <span id="checked">0</span> |
Gefunden: <span id="found">0</span> |
ETA: <span id="eta">â€“</span>
</div>

<hr>

<div id="info"></div>
<canvas id="chart" height="120"></canvas>

<hr>
<div id="warnings"></div>

<script>
// ================== KONFIGURATION ==================
const FINNHUB_KEY = "DEIN_API_KEY";
const MIN_DAYS = 10;
const TARGET_ASSETS = 10;

// Finanzkrisen
const CRISES = [
  { name:"Finanzkrise 2008", from:"2008-09-01", to:"2009-03-01" },
  { name:"Eurokrise", from:"2010-05-01", to:"2012-07-01" },
  { name:"Covid-Crash", from:"2020-02-15", to:"2020-04-15" },
  { name:"Zins/Tech-Crash", from:"2022-01-01", to:"2022-10-01" }
];

// Kandidaten
const STOCKS = ["AAPL","MSFT","GOOGL","AMZN","META","NVDA","TSLA","JPM","V","JNJ","KO","PEP","ADBE","ORCL","INTC"];
const CRYPTOS = ["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT"];

let validAssets = [];
let checkedCount = 0;
let startTime = Date.now();
let chart;
// ================== HISTORIE LADEN ==================
async function fetchStockHistory(symbol) {
  const to = Math.floor(Date.now()/1000);
  const from = to - 400*86400;
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${FINNHUB_KEY}`;
  const r = await fetch(url).then(r=>r.json());
  if (r.s !== "ok" || r.c.length < MIN_DAYS) throw "no data";
  return { type:"stock", symbol, dates:r.t.map(t=>new Date(t*1000)), prices:r.c };
}

async function fetchCryptoHistory(symbol) {
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=400`;
  const r = await fetch(url).then(r=>r.json());
  if (!Array.isArray(r) || r.length < MIN_DAYS) throw "no data";
  return {
    type:"crypto",
    symbol,
    dates: r.map(x=>new Date(x[0])),
    prices: r.map(x=>parseFloat(x[4]))
  };
}

// ================== ASSET SUCHEN ==================
async function searchAssets() {
  for (let s of STOCKS) {
    await tryAsset(()=>fetchStockHistory(s));
  }
  for (let c of CRYPTOS) {
    await tryAsset(()=>fetchCryptoHistory(c));
  }
  document.getElementById("searchStatus").textContent = "Suche abgeschlossen";
}

async function tryAsset(fn) {
  checkedCount++;
  document.getElementById("checked").textContent = checkedCount;
  try {
    const data = await fn();
    validAssets.push(data);
    addOption(data);
    document.getElementById("found").textContent = validAssets.length;
  } catch {}
  const elapsed = (Date.now()-startTime)/1000;
  document.getElementById("eta").textContent =
    Math.max(0, ((checkedCount+1)*elapsed/checkedCount - elapsed).toFixed(1))+"s";
}

// ================== UI ==================
function addOption(a) {
  const o = document.createElement("option");
  o.value = validAssets.length-1;
  o.textContent = `${a.symbol} (${a.type})`;
  assetSelect.appendChild(o);
}

function loadAsset() {
  const a = validAssets[assetSelect.value];
  renderChart(a);
  analyse(a);
}

// ================== ANALYSE ==================
function analyse(a) {
  const p = a.prices;
  const ret30 = ((p[p.length-1]-p[p.length-31])/p[p.length-31])*100;
  const vol = std(p.slice(-30));
  const dd = maxDrawdown(p);

  let html = `<h3>${a.symbol}</h3>`;
  html += `30T Performance: ${ret30.toFixed(2)}%<br>`;
  html += `VolatilitÃ¤t: ${vol.toFixed(2)}<br>`;
  html += `Max Drawdown: ${dd.toFixed(2)}%<br>`;
  html += `<a href="https://www.tradingview.com/symbols/${a.symbol}/" target="_blank">TradingView</a> |
           <a href="https://finance.yahoo.com/quote/${a.symbol}" target="_blank">Yahoo Finance</a>`;
  info.innerHTML = html;

  let w = "";
  if (dd < -20) w += "<div class='danger'>ðŸ”´ Starker Drawdown</div>";
  if (vol > (a.type==="crypto"?6:3)) w += "<div class='warn'>ðŸŸ  Hohe VolatilitÃ¤t</div>";
  warnings.innerHTML = w || "<div class='ok'>ðŸŸ¢ Keine akute Warnung</div>";
}

// ================== CHART ==================
function renderChart(a) {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type:"line",
    data:{
      labels:a.dates.map(d=>d.toISOString().slice(0,10)),
      datasets:[{ label:a.symbol, data:a.prices, borderColor:"#4caf50", pointRadius:0 }]
    }
  });
}

// ================== HILFSFUNKTIONEN ==================
function std(arr) {
  const m = arr.reduce((a,b)=>a+b)/arr.length;
  return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);
}
function maxDrawdown(p) {
  let peak=p[0], dd=0;
  for (let x of p) {
    if (x>peak) peak=x;
    dd=Math.min(dd,(x-peak)/peak*100);
  }
  return dd;
}

// START
searchAssets();
</script>
</body>
</html>
