<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-KI Asset Analyse â€“ Aktien Handel AG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<style>
body {
    background:#0d0f17;
    color:#e5e7eb;
    font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
    margin:0; padding:0; overflow:hidden;
}
header {
    position:fixed; top:0; left:0; right:0; height:120px;
    background:#11151f; border-bottom:1px solid #22c55e; z-index:100;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
}
header h1 { margin:0; font-size:1.8rem; }
header .subtitle { font-size:1rem; color:#94a3b8; }

.container {
    position:absolute; top:120px; bottom:50px; left:0; right:0;
    overflow-y:auto; padding:20px;
}

.card {
    background:#11151f;
    border:1px solid #1f2937;
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 4px 12px rgba(0,0,0,0.4);
}

.controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:12px; }
select, button {
    padding:10px; border-radius:8px; border:1px solid #22c55e;
    background:#0e111b; color:#e5e7eb; font-size:0.9rem; cursor:pointer; transition:0.2s;
}
select:hover, button:hover { background:#161b2c; }

.progress { height:12px; background:#1f2937; border-radius:6px; overflow:hidden; margin-top:8px; width:80%; margin-left:auto; margin-right:auto; }
.progress div { height:100%; width:0%; background:#38bdf8; transition:width 0.3s; }

.status { text-align:center; margin:10px 0; font-weight:bold; }
.loader { text-align:center; font-size:0.9rem; color:#a8dadc; margin-bottom:10px; }

canvas { background:#0e111b; border-radius:10px; display:block; margin:15px auto; max-width:100%; }

table { width:100%; border-collapse:collapse; margin-top:15px; font-size:0.85rem; }
th,td { border:1px solid #22c55e; padding:6px; text-align:center; }
.buy { color:#22c55e; font-weight:bold; }
.sell { color:#ef4444; font-weight:bold; }
.hold { color:#facc15; font-weight:bold; }
.conf { color:#38bdf8; font-weight:bold; }

footer {
    position:fixed; bottom:0; left:0; right:0; height:50px;
    background:#11151f; border-top:1px solid #22c55e; display:flex;
    align-items:center; justify-content:center; font-size:0.75rem; color:#94a3b8;
}

.scrollable-table {
    max-height:300px; overflow-y:auto;
}
</style>
</head>
<body>

<header>
    <h1>ðŸ”® Multi-KI Asset Analyse</h1>
    <div class="subtitle">FÃ¼r Aktien Handel AG â€“ Live & Professionell</div>
</header>

<div class="container">
    <div class="card">
        <h2>ðŸ“Œ Asset Scanner</h2>
        <div class="status" id="status">Status: Bereit</div>
        <div class="loader" id="loader">â€“</div>

        <div class="controls">
            <select id="assetSelect"><option>Lade Assetsâ€¦</option></select>
            <select id="timeRange">
                <option value="10">10 Tage</option>
                <option value="30">30 Tage</option>
                <option value="200">200 Tage</option>
                <option value="365">365 Tage</option>
            </select>
            <button onclick="loadAsset()">ðŸ“Š Analyse</button>
        </div>

        <div class="progress"><div id="progressBar"></div></div>
        <div class="status" id="progressText">Warte auf Datenâ€¦</div>
    </div>

    <div class="card">
        <h2>ðŸ’¹ Live-Kurs & Analyse</h2>
        <div id="currentPrice">Aktueller Kurs: â€“</div>
        <div id="period">Zeitraum: â€“</div>
        <canvas id="chart" height="220"></canvas>
    </div>

    <div class="card scrollable-table">
        <h2>ðŸ§  KI-Prognosen</h2>
        <table>
            <thead>
                <tr><th>KI-Modell</th><th>Prognose</th><th>Signal</th><th>Î”</th><th>Konfidenz</th><th>Datum/Uhrzeit</th></tr>
            </thead>
            <tbody id="out"></tbody>
        </table>
    </div>
</div>

<footer>@ Aktien Handel AG â€“ Professionelle Analyse</footer>
<script>
// ================== KONFIG ==================
const FINNHUB_KEY="DEIN_API_KEY_HIER"; // Finnhub API
let chart=null;
let liveInterval=null;
let validAssets=[];
let checkedCount=0;
let startTime=Date.now();

const MIN_DAYS=10;
const TARGET_ASSETS=20;
const DELAY=600; // ms zwischen Abfragen

// Aktien & Kryptos (Beispiel)
const STOCKS=["AAPL","MSFT","GOOGL","AMZN","TSLA","META","NVDA","JNJ","KO"];
const CRYPTOS=["BTCUSDT","ETHUSDT","BNBUSDT","ADAUSDT","SOLUSDT"];
const ALL_ASSETS=[...STOCKS.map(s=>({symbol:s,type:"stock"})),...CRYPTOS.map(c=>({symbol:c,type:"crypto"}))];

const assetSelect=document.getElementById("assetSelect");

// ================== HILFSFUNKTIONEN ==================
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function updateProgress(){
    const progressBar=document.getElementById("progressBar");
    const progressText=document.getElementById("progressText");
    const percent=Math.min((validAssets.length/TARGET_ASSETS)*100,100);
    progressBar.style.width=percent+"%";

    const elapsed=(Date.now()-startTime)/1000;
    const avg=checkedCount?elapsed/checkedCount:0;
    const remaining=Math.max((TARGET_ASSETS-validAssets.length)*avg,0);
    progressText.textContent=`Gefunden: ${validAssets.length}/${TARGET_ASSETS} | PrÃ¼ft: ${checkedCount} | ETA: ${Math.ceil(remaining)}s`;
}

// ================== HISTORISCHE DATEN ==================
async function fetchStockHistory(symbol,days=MIN_DAYS){
    const to=Math.floor(Date.now()/1000);
    const from=to-days*86400;
    const url=`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${FINNHUB_KEY}`;
    const res=await fetch(url).then(r=>r.json());
    if(res.s!=="ok" || !res.c || res.c.length<MIN_DAYS) throw "Keine Daten";
    return {symbol,type:"stock",prices:res.c,dates:res.t.map(t=>new Date(t*1000))};
}

async function fetchCryptoHistory(symbol,days=MIN_DAYS){
    const url=`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=${days}`;
    const res=await fetch(url).then(r=>r.json());
    if(!Array.isArray(res) || res.length<MIN_DAYS) throw "Keine Daten";
    return {symbol,type:"crypto",prices:res.map(x=>parseFloat(x[4])),dates:res.map(x=>new Date(x[0]))};
}

// ================== ASSET SUCHE ==================
async function searchAssets(){
    const periods=[365,200,MIN_DAYS];
    for(const days of periods){
        for(const a of ALL_ASSETS){
            if(validAssets.length>=TARGET_ASSETS) break;
            if(validAssets.find(v=>v.symbol===a.symbol)) continue;
            checkedCount++;
            try{
                let data=a.type==="stock" ? await fetchStockHistory(a.symbol,days) : await fetchCryptoHistory(a.symbol,days);
                validAssets.push(data);
                addOption(data);
            }catch(e){}
            updateProgress();
            await sleep(DELAY);
        }
        if(validAssets.length>=TARGET_ASSETS) break;
    }
    // Fortlaufende Suche falls < TARGET_ASSETS
    while(validAssets.length<TARGET_ASSETS){
        for(const a of ALL_ASSETS){
            if(validAssets.length>=TARGET_ASSETS) break;
            if(validAssets.find(v=>v.symbol===a.symbol)) continue;
            checkedCount++;
            try{
                let data=a.type==="stock" ? await fetchStockHistory(a.symbol,MIN_DAYS) : await fetchCryptoHistory(a.symbol,MIN_DAYS);
                validAssets.push(data);
                addOption(data);
            }catch(e){}
            updateProgress();
            await sleep(DELAY);
        }
    }
    document.getElementById("status").textContent="âœ… Alle Assets gefunden";
}

// ================== DROPDOWN ==================
function addOption(asset){
    if(validAssets.length===1) assetSelect.innerHTML="";
    const o=document.createElement("option");
    o.value=validAssets.length-1;
    o.textContent=`${asset.symbol} (${asset.type})`;
    assetSelect.appendChild(o);
}

// ======= AUTO-START SUCHE =======
searchAssets();

// ================== LIVE-KURSE ==================
async function fetchUsdChf(){try{const r=await fetch("https://api.exchangerate.host/latest?base=USD&symbols=CHF");const j=await r.json();return Number(j?.rates?.CHF)||0.93;}catch{return 0.93;}}
async function fetchQuote(sym){
    try{
        const url=sym.includes("USDT") ? `https://api.binance.com/api/v3/ticker/price?symbol=${sym}` : `https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`;
        const r=await fetch(url); const j=await r.json();
        if(sym.includes("USDT")) return parseFloat(j.price);
        if(j.c!==undefined) return Number(j.c);
        throw "Keine Kursdaten";
    }catch(e){throw e;}
}

async function startLivePrice(idx){
    const currentDiv=document.getElementById("currentPrice");
    const asset=validAssets[idx];
    async function updatePrice(){
        try{
            const usd=await fetchQuote(asset.symbol);
            const fx=asset.type==="crypto"?1:await fetchUsdChf();
            currentDiv.textContent=`Aktueller Kurs: ${(usd*fx).toFixed(2)} ${asset.type==="crypto"?"USDT":"CHF"}`;
        }catch(err){currentDiv.textContent=`Fehler: ${err}`;}
    }
    await updatePrice();
    if(liveInterval) clearInterval(liveInterval);
    liveInterval=setInterval(updatePrice,5000);
}
</script>
<script>
// ================== KI-PROGNOSE ==================
async function predictModelVaried(data, basePeriod, kiIndex){
    const period=basePeriod + kiIndex*2;
    const noisyData=data.prices.map(v=>v*(1+(Math.random()-0.5)/100));

    const min=Math.min(...noisyData);
    const max=Math.max(...noisyData);
    const norm=noisyData.map(v=>(v-min)/(max-min||1));

    let X=[],Y=[];
    for(let i=0;i<norm.length-period;i++){
        X.push(norm.slice(i,i+period).map(v=>[v]));
        Y.push([norm[i+period]]);
    }
    if(X.length===0 || Y.length===0) return data.prices[data.prices.length-1];

    const xs=tf.tensor3d(X);
    const ys=tf.tensor2d(Y);

    const units=12+kiIndex*2;
    const model=tf.sequential();
    model.add(tf.layers.lstm({units,inputShape:[period,1]}));
    model.add(tf.layers.dense({units:1}));
    model.compile({optimizer:"adam",loss:"meanSquaredError"});

    await model.fit(xs,ys,{epochs:5,verbose:0});
    const p=model.predict(tf.tensor3d([X.at(-1)])).dataSync()[0];
    return p*(max-min)+min;
}

// ================== KONFIDENZ ==================
function getConfidence(diff){
    return Math.abs(diff)>0.1?"Hoch":Math.abs(diff)>0.05?"Mittel":"Niedrig";
}

// ================== ASSET LADEN ==================
async function loadAsset(){
    const idx=assetSelect.value;
    if(idx===null) return;
    const asset=validAssets[idx];
    const basePeriod=parseInt(document.getElementById("timeRange").value);
    document.getElementById("period").textContent=`Zeitraum: ${basePeriod} Tage`;

    await startLivePrice(idx);

    const hist=asset;
    const prognosen=[];
    for(let i=0;i<4;i++){
        try{ prognosen[i]=await predictModelVaried(hist, basePeriod, i); }
        catch(e){ prognosen[i]=hist.prices[hist.prices.length-1]; }
    }

    drawChart(hist,prognosen);
    displayTable(hist,prognosen);
}

// ================== CHART ==================
function drawChart(hist,prognosen){
    if(chart) chart.destroy();
    const labels=hist.dates.map(d=>d.toISOString().slice(0,10));
    const avg=prognosen.reduce((a,b)=>a+b,0)/prognosen.length;

    chart=new Chart(document.getElementById("chart"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {label:"KI1",data:[...Array(hist.prices.length-1).fill(null),prognosen[0]],borderColor:"#22c55e",fill:false},
                {label:"KI2",data:[...Array(hist.prices.length-1).fill(null),prognosen[1]],borderColor:"#3b82f6",fill:false},
                {label:"KI3",data:[...Array(hist.prices.length-1).fill(null),prognosen[2]],borderColor:"#f97316",fill:false},
                {label:"KI4",data:[...Array(hist.prices.length-1).fill(null),prognosen[3]],borderColor:"#facc15",fill:false},
                {label:"Durchschnitt",data:[...Array(hist.prices.length-1).fill(null),avg],borderColor:"#ffffff",fill:false}
            ]
        },
        options:{responsive:true,maintainAspectRatio:false}
    });
}

// ================== TABELLE ==================
function displayTable(hist,prognosen){
    const out=document.getElementById("out");
    const current=hist.prices[hist.prices.length-1];
    const now=new Date().toLocaleString();
    let html="";
    prognosen.forEach((p,i)=>{
        const diff=(p-current)/current;
        const sig=diff>0.05?"buy":diff<-0.05?"sell":"hold";
        html+=`<tr><td>KI${i+1}</td><td>${p.toFixed(2)}</td><td class="${sig}">${sig.toUpperCase()}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${getConfidence(diff)}</td><td>${now}</td></tr>`;
    });
    const avg=prognosen.reduce((a,b)=>a+b,0)/prognosen.length;
    const diff=(avg-current)/current;
    const sig=diff>0.05?"buy":diff<-0.05?"sell":"hold";
    html+=`<tr><td>Durchschnitt</td><td>${avg.toFixed(2)}</td><td class="${sig}">${sig.toUpperCase()}</td><td>${(diff*100).toFixed(1)}%</td><td class="conf">${getConfidence(diff)}</td><td>${now}</td></tr>`;
    out.innerHTML=html;
}

// ================== KAUF-/INFO-LINKS ==================
function openYahoo(){
    const idx=assetSelect.value;
    if(idx===null) return;
    const sym=validAssets[idx].symbol;
    window.open(`https://finance.yahoo.com/quote/${sym}`,"_blank");
}

function openTradingView(){
    const idx=assetSelect.value;
    if(idx===null) return;
    const a=validAssets[idx];
    const sym=a.type==="crypto" ? `BINANCE:${a.symbol}` : a.symbol;
    window.open(`https://www.tradingview.com/chart/?symbol=${sym}`,"_blank");
}

function openSwissquote(){
    const idx=assetSelect.value;
    if(idx===null) return;
    const sym=validAssets[idx].symbol;
    window.open(`https://www.swissquote.ch/sqw-en/private/trading/instruments/search?query=${sym}`,"_blank");
}
</script>
<script>
// ================== MULTI-ASSET VERGLEICH ==================
async function compareAssets(selectedIndices){
    if(selectedIndices.length===0) return;
    const compareDatasets=[];
    selectedIndices.forEach(idx=>{
        const asset=validAssets[idx];
        compareDatasets.push({
            label: asset.symbol,
            data: asset.prices,
            borderColor:getRandomColor(),
            pointRadius:0,
            fill:false
        });
    });

    if(chart) chart.destroy();
    const labels=validAssets[0].dates.map(d=>d.toISOString().slice(0,10));
    chart=new Chart(document.getElementById("chart"),{
        type:"line",
        data:{labels,datasets:compareDatasets},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}}}
    });
}

// ================== FINANZKRISEN-MARKIERUNG ==================
const CRISES=[
    {name:"Finanzkrise 2008",from:"2008-09-01",to:"2009-06-30"},
    {name:"COVID-19 Crash",from:"2020-02-15",to:"2020-04-30"}
];

function markCrises(){
    if(!chart) return;
    const ctx=chart.ctx;
    CRISES.forEach(c=>{
        const from=new Date(c.from);
        const to=new Date(c.to);
        const startIdx=chart.data.labels.findIndex(d=>new Date(d)>=from);
        const endIdx=chart.data.labels.findIndex(d=>new Date(d)>=to);
        if(startIdx>=0 && endIdx>=0){
            const xStart=chart.scales.x.getPixelForValue(startIdx);
            const xEnd=chart.scales.x.getPixelForValue(endIdx);
            ctx.fillStyle="rgba(255,165,0,0.2)";
            ctx.fillRect(xStart,chart.chartArea.top,xEnd-xStart,chart.chartArea.bottom-chart.chartArea.top);
        }
    });
}

// ================== HILFSFUNKTION ==================
function getRandomColor(){
    const r=Math.floor(Math.random()*200+30);
    const g=Math.floor(Math.random()*200+30);
    const b=Math.floor(Math.random()*200+30);
    return `rgb(${r},${g},${b})`;
}

// ================== AUTO-UPDATE LIVE-KURSE ==================
setInterval(()=>{
    const idx=assetSelect.value;
    if(idx!==null) startLivePrice(idx);
},300000); // alle 5 Minuten

// ================== OPTIONAL: MULTI-ASSET SELECTION ==================
assetSelect.addEventListener("change",()=>{
    const idx=assetSelect.value;
    if(idx!==null){
        startLivePrice(idx);
        loadAsset();
    }
});
</script>
</body>
</html>
